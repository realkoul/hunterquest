<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>ì—ì¹´ ì‘ìœ„ í€˜ìŠ¤íŠ¸ (Simple)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        body { font-family: 'Segoe UI', AppleSDGothicNeo, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; display: none; }
        button { cursor: pointer; transition: 0.2s; font-family: inherit; }
        
        .btn-add { background-color: #2c3e50; color: white; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; }
        .btn-excel { background-color: #27ae60; color: white; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-reset { background-color: #e74c3c; color: white; padding: 8px 15px; border-radius: 6px; border: none; font-size: 0.9rem; }
        
        .control-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .input-wrapper { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .input-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-text { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 200px; font-size: 1rem; }

        .stats { display: flex; gap: 15px; margin-bottom: 30px; background: white; padding: 15px; border-radius: 8px; flex-wrap: wrap; justify-content: space-around; }
        .stat-box { font-weight: bold; font-size: 1rem; display: flex; align-items: center; gap: 5px; }

        section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #2c3e50; font-size: 1.3rem; margin-bottom: 15px; }
        
        .slots-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .slot { flex: 1; min-width: 280px; max-width: 400px; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; text-align: center; background: white; }
        .slot.active { border-color: #3498db; background-color: #f0f8ff; }
        .slot.empty { border: 2px dashed #bdc3c7; background-color: #fafafa; color: #aaa; min-height: 150px; justify-content: center; align-items: center; }
        .info-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; color: white; margin-bottom: 5px; background: #95a5a6; }
        .bg-green { background: #27ae60; }
        .btn-action { border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; color: white; font-size: 1rem; }
        .btn-end { background-color: #7f8c8d; }
        
        .queue-container { width: 100%; }
        .queue-list { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .queue-card { width: 100%; max-width: 180px; background: #fff8e1; border: 1px solid #ffe082; border-radius: 8px; padding: 15px; text-align: center; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; }
        .queue-rank { position: absolute; top: -10px; left: -10px; background: #ff9800; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; width: 100%; }
        .btn-common-style { flex: 1; width: 0; border: none; padding: 8px 2px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; white-space: nowrap; display: flex; justify-content: center; align-items: center; }
        .btn-enter { background-color: #27ae60; color: white; } .btn-enter:hover { background-color: #219150; }
        .btn-swap { background-color: #d35400; color: white; } .btn-swap:hover { background-color: #e67e22; }
        .btn-disabled-card { background-color: #bdc3c7; color: #fff; cursor: not-allowed; }
        .btn-blocked-queue { background-color: #e67e22; color: #fff; cursor: not-allowed; }
        .btn-cancel-queue { margin-top: 5px; width: 100%; background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 5px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .btn-cancel-queue:hover { background: #e74c3c; color: white; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 0.9rem; white-space: nowrap; }
        th { background-color: #f8f9fa; color: #555; }
        
        input.edit-name { width: 150px; padding: 6px; border: 1px solid transparent; background: transparent; font-size: 0.95rem; }
        input.edit-name:focus { border-color: #3498db; background: white; outline: none; border-radius: 4px; }
        input.edit-count { width: 60px; padding: 8px; text-align: center; border: 2px solid #f39c12; border-radius: 6px; font-weight: bold; color: #d35400; font-size: 1rem; background-color: #fffaf0; }
        input.edit-count:focus { border-color: #e67e22; background-color: #fff; outline: none; }
        
        .btn-apply, .btn-cancel, .btn-delete { padding: 6px 10px; border-radius: 4px; border: none; font-size: 0.85rem; margin-right: 2px; color: white; cursor: pointer;}
        .btn-apply { background-color: #3498db; }
        .btn-cancel { background-color: #e74c3c; }
        .btn-delete { background-color: #c0392b; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .input-wrapper { flex-direction: column; align-items: stretch; gap: 15px; }
            .input-group { width: 100%; justify-content: space-between; }
            .input-text { flex: 1; }
            .btn-add, .btn-excel { width: 100%; margin-top: 5px; }
            .slot { min-width: 100%; }
            .queue-card { max-width: 47%; flex: 1 1 40%; }
            .stats { gap: 10px; padding: 10px; }
            .stat-box { font-size: 0.9rem; }
            h1 { font-size: 1.5rem; }
            th, td { padding: 10px 5px; }
        }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .role-btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-role { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; font-size: 1rem; }
        .btn-cancel-modal { margin-top: 10px; background: transparent; border: 1px solid #ccc; padding: 8px; border-radius: 6px; color: #666; width: 100%; }
        .role-tainer { background-color: #e74c3c; } .role-hide { background-color: #8e44ad; } .role-perfo { background-color: #2980b9; }
        .role-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.8rem; font-weight: bold; margin-right: 5px; vertical-align: middle; }
        .st-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .st-idle { background: #eee; color: #777; } .st-waiting { background: #fff3cd; color: #856404; } .st-active { background: #d1ecf1; color: #0c5460; }
        #loading-cover { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; font-size:1.5rem; color:#2c3e50; font-weight:bold; }
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .lock-box { background: white; padding: 30px; border-radius: 12px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 80%; max-width: 300px; }
        .lock-input { padding: 10px; font-size: 1.2rem; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; text-align: center; margin-bottom: 10px; }
        .btn-unlock { padding: 10px 20px; font-size: 1rem; background: #27ae60; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-unlock:hover { background: #219150; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h2 style="margin-top:0;">ğŸ”’ ì ‘ê·¼ ì œí•œ</h2>
        <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="password-input" class="lock-input" placeholder="Password" onkeypress="if(event.key==='Enter') window.checkPassword()">
        <br>
        <button class="btn-unlock" onclick="window.checkPassword()">ì… ì¥</button>
        <p id="password-error" style="color:#e74c3c; display:none; margin-top:10px; font-weight:bold;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
    </div>
</div>

<div id="loading-cover" style="display:none;">ì„œë²„ ì—°ê²° ì¤‘...</div>

<div class="container" id="main-container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <div>
            <h1 style="margin:0;">ğŸ›¡ï¸ ì—ì¹´ ì‘ìœ„ í€˜ìŠ¤íŠ¸ (LIVE)</h1>
            <span style="color:#27ae60; font-weight:bold; font-size:0.85rem;">â— hunterquest-fbdee ì„œë²„ ì—°ë™ë¨</span>
        </div>
        <button class="btn-reset" id="btn-reset-all">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>

    <div class="stats">
        <div class="stat-box">ì „ì²´: <span id="total-cnt">0</span></div>
        <div class="stat-box" style="color:#e67e22;">â³ ëŒ€ê¸°: <span id="waiting-cnt">0</span></div>
        <div class="stat-box" style="color:#2980b9;">ğŸ”¥ ì§„í–‰: <span id="active-cnt">0</span></div>
    </div>

    <section>
        <h2>ğŸ”¥ ì§„í–‰ ì¤‘ (3 Slots)</h2>
        <div class="slots-container" id="slots-container"></div>
    </section>

    <section>
        <h2>â³ ëŒ€ê¸° ëª…ë‹¨ (ì „ì²´ ë³´ê¸°)</h2>
        <div style="margin-bottom:15px; background:#e8f6f3; padding:10px; border-radius:4px; color:#16a085; font-size:0.9rem; line-height: 1.5;">
            <strong>ğŸš€ ë£° ì•ˆë‚´:</strong><br>
            <strong>ğŸ¯ ìˆœì„œ:</strong> 1.ì™„ë£Œ íšŸìˆ˜ ì ìŒ &gt; 2.ì‹ ì²­ ìˆœì„œ (ì„ ì°©ìˆœ)<br>
            1. í€˜ìŠ¤íŠ¸ ì¤‘ë³µ ì‹œ ì…ì¥ ë¶ˆê°€ (ê²¹ì¹˜ë©´ ìˆœë²ˆ ìœ ì§€)<br>
            2. <strong>[â–¼ ìˆœë²ˆë¯¸ë£¨ê¸°]</strong>: ê°™ì€ í€˜ìŠ¤íŠ¸ ëŒ€ê¸°ìê°€ ìˆìœ¼ë©´ êµì²´, ì—†ìœ¼ë©´ ë’·ì‚¬ëŒì—ê²Œ ì–‘ë³´<br>
        </div>
        <div class="queue-container">
            <div class="queue-list" id="queue-list"></div>
        </div>
    </section>

    <section>
        <h2>ğŸ‘¥ ì „ì²´ ì°¸ì—¬ì ê´€ë¦¬</h2>
        <div style="margin-bottom:10px; color:#d35400; font-size:0.9rem;">
            * ì™„ë£Œ íšŸìˆ˜ ìˆ«ìë¥¼ í´ë¦­í•˜ê³  ìˆ˜ì • í›„ <strong>ì—”í„°(Enter)</strong>ë¥¼ ëˆ„ë¥´ë©´ ì €ì¥ë©ë‹ˆë‹¤.
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="8%">ID</th>
                        <th width="25%">ì´ë¦„</th>
                        <th width="12%">ì™„ë£Œ</th>
                        <th width="25%">ìƒíƒœ / í€˜ìŠ¤íŠ¸</th>
                        <th width="20%">ì‹œì‘ ì‹œê°„</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="participant-table"></tbody>
            </table>
        </div>
    </section>
    </section>


    <div class="control-panel" style="text-align: center;">
        <button class="btn-excel" onclick="window.openLogModal()" style="font-size: 1rem; padding: 15px 30px;">
            ğŸ“‹ ë³€ê²½ ë¡œê·¸ ë³´ê¸° (ê´€ë¦¬ì)
        </button>
    </div>

    <div class="control-panel">
        <div class="input-wrapper">
            <div class="input-group" style="flex: 2;">
                <strong>ğŸ‘¤ ê°œë³„:</strong>
                <input type="text" id="new-name" class="input-text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" >
            </div>
            <button class="btn-add" id="btn-add-user" style="flex: 1;">ë“±ë¡</button>
        </div>
        <div style="margin-top: 10px;">
            <input type="file" id="excel-file" accept=".xlsx, .xls" style="display: none;" onchange="window.handleExcelUpload(event)">
            <button class="btn-excel" style="width:100%;" onclick="document.getElementById('excel-file').click()">
                ğŸ“‚ ì—‘ì…€ ì¼ê´„ ë“±ë¡
            </button>
        </div>
    </div>
</div>

<div id="roleModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0;">í€˜ìŠ¤íŠ¸ ì„ íƒ</h3>
        <p style="color:#666; font-size:0.9rem;">ì§„í–‰í•  í€˜ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
        <div class="role-btn-group">
            <button class="btn-role role-tainer" onclick="confirmRole('í…Œì´ë„ˆ')">1. í…Œì´ë„ˆ</button>
            <button class="btn-role role-hide" onclick="confirmRole('í•˜ì´ë“œ')">2. í•˜ì´ë“œ</button>
            <button class="btn-role role-perfo" onclick="confirmRole('í¼í¬')">3. í¼í¬</button>
        </div>
        <button class="btn-cancel-modal" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<!-- ë¡œê·¸ ëª¨ë‹¬ -->
<div id="logModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 1200px; width: 90%; min-height: 500px; max-height: 85vh; overflow-y: auto; padding: 25px;">
        <h3 style="margin-top:0;">ğŸ“‹ ë³€ê²½ ë¡œê·¸ (ìµœê·¼ 100ê°œ)</h3>
        <button class="btn-excel" onclick="window.refreshLogsInModal()" style="margin-bottom: 15px; width: auto;">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
        <div class="table-wrapper" style="min-height: 300px;">
            <table>
                <thead>
                    <tr>
                        <th width="18%">ì‹œê°„</th>
                        <th width="12%">ì‚¬ìš©ì</th>
                        <th width="12%">ë³€ê²½ í•­ëª©</th>
                        <th width="15%">ì´ì „ ê°’</th>
                        <th width="15%">ìƒˆ ê°’</th>
                        <th width="15%">ë³€ê²½ì</th>
                    </tr>
                </thead>
                <tbody id="log-table-modal"></tbody>
            </table>
        </div>
        <button class="btn-cancel-modal" onclick="window.closeLogModal()" style="margin-top: 15px;">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";

    // ë²„ì „ ì²´í¬ (í˜ì´ì§€ ìƒë‹¨ì— ì¶”ê°€)
    const CURRENT_VERSION = "2.0.0"; // ì—…ë°ì´íŠ¸ ì‹œ ë³€ê²½
    const STORED_VERSION = localStorage.getItem('appVersion');
    
    if (STORED_VERSION !== CURRENT_VERSION) {
        alert('ğŸ”„ ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤!\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.\n(ë°ì´í„°ëŠ” ì•ˆì „í•©ë‹ˆë‹¤)');
        localStorage.setItem('appVersion', CURRENT_VERSION);
        location.reload();
    }
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJ9CRer5FEjA1_yZ5g1jBypaX_3Cpqqyo",
      authDomain: "hunterquest-fbdee.firebaseapp.com",
      databaseURL: "https://hunterquest-fbdee-default-rtdb.firebaseio.com",
      projectId: "hunterquest-fbdee",
      storageBucket: "hunterquest-fbdee.firebasestorage.app",
      messagingSenderId: "999017602063",
      appId: "1:999017602063:web:711b798bb7405ddbfe577a",
      measurementId: "G-13WEG56NZR"
    };

    const SITE_PASSWORD = "1234";
    const RESET_PASSWORD = "0000";
    const EDIT_PASSWORD = "9876"; 

    const RAW_NAMES = [
        "í—Œí„°íˆ¬ì¸", "í—Œí„°ì•¼í•´", "í—Œí„°íŒŒê°œ", "í—Œí„°ìœ ë ¹", "í—Œí„°ì›ì´", "í—Œí„°ë¡œë˜", "í—Œí„°í¬ë™", "í—Œí„°ê³ ìˆ˜", 
        "í—Œí„°ê±°ë¯¸", "í—Œí„°ì›ë¹ˆ", "í—Œí„°ì œë¦¬", "í—Œí„°ì‚´ë²Œ", "í—Œí„°ì§íŒ¨", "í—Œí„°ì¡°ì´", "í—Œí„°ì§ˆëŸ¿", "í—Œí„°í…Œì´", 
        "í—Œí„°ë§ˆë¦°", "í—Œí„°ë§ë´‰", "í—Œí„°ê³µí¬", "í—Œí„°ë¹¡êµ¬", "í—Œí„°ì‹ ì¡°", "í—Œí„°íƒ€ë…¸ìŠ¤", "í—Œí„°ë‚˜ì˜", "í—Œí„°ë°±ìˆ˜", 
        "í—Œí„°í‹°ëª¨", "í—Œí„°ì‘ë‘", "í—Œí„°ì¼ë¯¼", "í—Œí„°ìˆ˜í˜¸", "í—Œí„°ì˜ì›…", "í—Œí„°ì¸ í‚¤", "í—Œí„°ì„ ê³µ", "í—Œí„°ë°ë°", 
        "í—Œí„°ë™ë°©", "í—Œí„°í¼ì´", "í—Œí„°ë²„ê¸°", "í—Œí„°ë ˆì˜¤", "í—Œí„°ì˜ì£¼", "í—Œí„°ë°¸ë¦¬", "í—Œí„°ì€ì„¬", "í—Œí„°ë°”ë“œ", 
        "í—Œí„°íˆë°", "í—Œí„°í˜¼ê³ ", "í—Œí„°ë¹„ë””", "í—Œí„°ë¹µì•¼", "í—Œí„°ê°ì", "í—Œí„°ì„¼ì„¸", "í—Œí„°í‚¤ìœ„", "í—Œí„°ë³¼ë“œ", 
        "í—Œí„°ì¶˜ë´‰", "í—Œí„°ë‹ˆì´", "í—Œí„°ë§ë­", "íˆë“ íƒ±íƒ±", "í—Œí„°ë“œì§„", "í—Œí„°ìœ ë¡œ", "í—Œí„°ê³ êµ¬ë§ˆ", "í—Œí„°ë³µì„œ", "í—Œí„°í™©ì›”",
        "ë‚˜ì•—", "ë±ìŠ¤", "ìˆ­ì´", "êµ¬ì°Œ", "ì‹¬", "ì§€ì¸", "ì½”ìŠ¤", "í“¨ë¦¬", "ì¤‘ë…", "ë§¤ì½¤", "ê°„ì§€", 
        "ì„±ìš©", "ê¸°ìœ ", "ë‚˜êµ¬ë¦¬", "ì½©ì´", "í›„ë§¨", "ë¡œì´", "ê¹œëƒ¥", "ì´ë„", "ë¹„íŠ¸", "ì§„ìƒ",
        "í—Œí„°ë°°ì¶”", "í—Œí„°ì˜ë "
    ];

    window.checkPassword = () => {
        const input = document.getElementById('password-input').value;
        const errorMsg = document.getElementById('password-error');
        if (input === SITE_PASSWORD) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('loading-cover').style.display = 'flex';
            startFirebase(); 
        } else {
            errorMsg.style.display = 'block';
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }
    };

    function startFirebase() {
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'eka_quest_users');
        window.changeLogRef = ref(db, 'eka_change_logs'); // ë³€ê²½ ë¡œê·¸ ì €ì¥ì†Œ

        window.users = [];
        window.MAX_ACTIVE = 3;
        window.targetUserId = null;

        // ë³€ê²½ ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜
        // ë¡œê·¸ ì¹´ìš´í„° (ê°™ì€ ë°€ë¦¬ì´ˆì— ì—¬ëŸ¬ ë¡œê·¸ ì €ì¥ ì‹œ ì¶©ëŒ ë°©ì§€)
        let logCounter = 0;
        
        window.logChange = (userId, userName, field, oldValue, newValue, changedBy = 'ì‹œìŠ¤í…œ') => {
            const timestamp = new Date().toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            const logEntry = {
                timestamp: timestamp,
                userId: userId,
                userName: userName,
                field: field,
                oldValue: oldValue,
                newValue: newValue,
                changedBy: changedBy
            };
            
            // ê³ ìœ í•œ í‚¤ ìƒì„±: íƒ€ì„ìŠ¤íƒ¬í”„ + ì¹´ìš´í„° (ë®ì–´ì“°ê¸° ë°©ì§€)
            const uniqueKey = Date.now() + '_' + (logCounter++);
            const newLogRef = ref(db, 'eka_change_logs/' + uniqueKey);
            set(newLogRef, logEntry).catch(error => console.error('ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', error));
            
            console.log('[ë³€ê²½ ë¡œê·¸]', logEntry);
        };

        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // null/undefined í•­ëª© ì œê±°
                window.users = Array.isArray(data) ? data.filter(u => u && u.id) : data;
                checkForNewMembers(); 
            } else {
                initDataWithImageContent();
            }
            render();
            document.getElementById('loading-cover').style.display = 'none';
        });

        // ë Œë”ë§ ì‹œê°„ ì¶”ì  ë³€ìˆ˜
        let lastRenderTime = 0;
        
        // ì•ˆì „í•œ ì €ì¥ (Transaction ì‚¬ìš©)
        window.saveData = () => {
            // ì „ì²´ ë°°ì—´ ì €ì¥ (ì¤‘ë³µ ë°©ì§€)
            set(dbRef, window.users)
                .then(() => {
                    console.log('[ì €ì¥ ì„±ê³µ]');
                    render();
                    lastRenderTime = Date.now();
                })
                .catch((error) => {
                    console.error('[ì €ì¥ ì‹¤íŒ¨]', error);
                });
        };

    }

    function checkForNewMembers() {
        let changed = false;
        let nextId = 1;
        if (window.users.length > 0) {
            nextId = Math.max(...window.users.map(u => u.id)) + 1;
        }

        RAW_NAMES.forEach(name => {
            const exists = window.users.some(u => u.name === name);
            if (!exists) {
                window.users.push({
                    id: nextId++,
                    name: name,
                    completedCount: 0,
                    role: '',
                    status: 'idle',
                    waitingTime: null,
                    startTime: null
                });
                changed = true;
            }
        });

        if (changed) {
            window.saveData();
        }
    }

    function executePostponeLogic(myUser) {
        if (!myUser.role) return;
        
        const waitingUsersWithRole = window.users.filter(u => u && u.id).filter(user => user.status === 'waiting' && user.role === myUser.role).sort((a, b) => {
            const aPostponed = a.postponedOrder !== undefined ? a.postponedOrder : 0;
            const bPostponed = b.postponedOrder !== undefined ? b.postponedOrder : 0;
            if (aPostponed !== bPostponed) return aPostponed - bPostponed;
            if (a.completedCount !== b.completedCount) return a.completedCount - b.completedCount;
            return a.waitingTime - b.waitingTime;
        });
        
        const currentIdx = waitingUsersWithRole.findIndex(user => user.id === myUser.id);
        if (currentIdx !== 0 || waitingUsersWithRole.length < 2) return;
        
        const postponedUsers = waitingUsersWithRole.filter(user => {
            const userInArray = window.users.filter(u => u && u.id).find(u => u.id === user.id);
            return userInArray.postponedOrder !== undefined && userInArray.postponedOrder > 0;
        });
        
        let maxPostponedOrder = 0;
        postponedUsers.forEach(user => {
            const userInArray = window.users.filter(u => u && u.id).find(u => u.id === user.id);
            if (userInArray.postponedOrder > maxPostponedOrder) {
                maxPostponedOrder = userInArray.postponedOrder;
            }
        });
        
        console.log('[ë¯¸ë£¨ê¸° ì „] ì—­í• :', myUser.role);
        console.log('[ë¯¸ë£¨ê¸° ì „] ëŒ€ê¸°ì—´:', waitingUsersWithRole.map((u, i) => `${i+1}.${u.name}(${u.postponedOrder || 0})`).join(' '));
        
        const firstUserInArray = window.users.filter(u => u && u.id).find(user => user.id === waitingUsersWithRole[0].id);
        firstUserInArray.postponedOrder = maxPostponedOrder + 1;
        window.logChange(firstUserInArray.id, firstUserInArray.name, "postponedOrder", maxPostponedOrder, maxPostponedOrder + 1, "ìˆœë²ˆ ë¯¸ë£¨ê¸° ë²„íŠ¼");
        console.log('[ë¯¸ë£¨ê¸°] 1ë“±', firstUserInArray.name, 'â†’ postponedOrder:', firstUserInArray.postponedOrder);
        
        
        waitingUsersWithRole.forEach(user => {
            const userInArray = window.users.filter(u => u && u.id).find(u => u.id === user.id);
            if (userInArray.postponedOrder === undefined) {
                userInArray.postponedOrder = 0;
            }
        });
    }

    function initDataWithImageContent() {
        const uniqueData = [];
        const seenNames = new Set();
        let nextId = 1;
        
        RAW_NAMES.forEach(name => {
            if (!seenNames.has(name)) {
                seenNames.add(name);
                uniqueData.push({
                    id: nextId++,
                    name: name,
                    completedCount: 0,
                    role: '',
                    status: 'idle',
                    waitingTime: null,
                    startTime: null
                });
            }
        });
        window.users = uniqueData;
        window.saveData();
    }

    // íšŸìˆ˜ ìˆ˜ì • í•¨ìˆ˜ (ë¹„ë°€ë²ˆí˜¸ ì²´í¬)
    window.updateCompletedCount = (id, newVal, inputEl) => {
        const user = window.users.filter(u => u && u.id).find(u => u.id === id);
        if (!user) return;

        if (user.completedCount == newVal) return;

        const originalVal = user.completedCount;
        const parsedVal = parseInt(newVal);

        if (isNaN(parsedVal) || parsedVal < 0) {
            alert("ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            inputEl.value = originalVal;
            return;
        }

        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (íšŸìˆ˜ ìˆ˜ì •):");
        if (pw === EDIT_PASSWORD) {
            user.completedCount = parsedVal;
            window.saveData();
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            inputEl.value = originalVal; // ë³µêµ¬
        }
    };

    function render() {
        const users = window.users;
        const waitingUsers = users.filter(u => u.status === 'waiting')
            .sort((a, b) => {
                const aPostponed = a.postponedOrder !== undefined ? a.postponedOrder : 0;
                const bPostponed = b.postponedOrder !== undefined ? b.postponedOrder : 0;
                if (aPostponed !== bPostponed) return aPostponed - bPostponed;
                if (a.completedCount !== b.completedCount) return a.completedCount - b.completedCount;
                return a.waitingTime - b.waitingTime;
            });

        const activeUsers = users.filter(u => u.status === 'active');
        const currentRoles = activeUsers.map(u => u.role);

        document.getElementById('total-cnt').innerText = users.length;
        document.getElementById('waiting-cnt').innerText = waitingUsers.length;
        document.getElementById('active-cnt').innerText = activeUsers.length;

        const slotsDiv = document.getElementById('slots-container');
        slotsDiv.innerHTML = '';
        for (let i = 0; i < window.MAX_ACTIVE; i++) {
            const user = activeUsers[i];
            const div = document.createElement('div');
            if (user) {
                div.className = 'slot active';
                div.innerHTML = `
                    <div>
                        <span class="info-badge bg-green">${user.completedCount}íšŒ ì™„ë£Œ</span>
                        <h3 style="margin:10px 0;">${getRoleBadge(user.role)} ${user.name}</h3>
                        <small style="color:#888">${user.startTime} ì‹œì‘</small>
                    </div>
                    <button class="btn-action btn-end" onclick="finishWork(${user.id})">ì¢…ë£Œ (íšŸìˆ˜ +1)</button>
                `;
            } else {
                div.className = 'slot empty';
                div.innerHTML = `<h3>ë¹ˆ ìŠ¬ë¡¯ ${i + 1}</h3><div style="font-size:0.9rem;">ì…ì¥ ëŒ€ê¸° ì¤‘...</div>`;
            }
            slotsDiv.appendChild(div);
        }

        const queueDiv = document.getElementById('queue-list');
        queueDiv.innerHTML = '';
        if (waitingUsers.length === 0) {
            queueDiv.innerHTML = '<div style="padding:15px; color:#999;">ëŒ€ê¸° ì¤‘ì¸ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        } else {
            const hasEmptySlot = activeUsers.length < window.MAX_ACTIVE;
            let enabledButtonCount = 0; 
            const queuedRoles = new Set(); 

            waitingUsers.forEach((u, idx) => {
                const card = document.createElement('div');
                card.className = 'queue-card';
                
                const isBlockedByActive = currentRoles.includes(u.role);
                const isBlockedByQueue = queuedRoles.has(u.role);
                queuedRoles.add(u.role);

                let mainBtn = '';
                if (!hasEmptySlot) {
                    mainBtn = `<button disabled class="btn-common-style btn-disabled-card">ìŠ¬ë¡¯ ê½‰ì°¸</button>`;
                } else if (isBlockedByActive) {
                    mainBtn = `<button disabled class="btn-common-style btn-disabled-card" style="color:#e74c3c;">â›” ì§„í–‰ ì¤‘</button>`;
                } else if (isBlockedByQueue) {
                    mainBtn = `<button disabled class="btn-common-style btn-blocked-queue">âœ‹ ëŒ€ê¸° ì¤‘</button>`;
                } else {
                    if (enabledButtonCount < 4) {
                        mainBtn = `<button class="btn-common-style btn-enter" onclick="startWork(${u.id})">ì…ì¥ í•˜ê¸°</button>`;
                        enabledButtonCount++;
                    } else {
                         mainBtn = `<div style="font-size:0.8rem; color:#aaa; font-weight:bold; padding:8px 0; width:100%;">ìˆœë²ˆ ${idx + 1}</div>`;
                    }
                }

                let swapBtn = '';
                const sameRoleWaiting = waitingUsers.filter(user => user.role === u.role);
                if (sameRoleWaiting.length >= 2) {
                    const roleIdx = sameRoleWaiting.findIndex(user => user.id === u.id);
                    const isFirstInRole = roleIdx === 0;
                    if (isFirstInRole) {
                        swapBtn = `<button class="btn-common-style btn-swap" onclick="window.postponeTurn(${u.id})">â–¼ ìˆœë²ˆë¯¸ë£¨ê¸°</button>`;
                    } else {
                        swapBtn = `<button class="btn-common-style btn-swap" disabled style="opacity:0.5; cursor:not-allowed; background:#cbd5e0;">â–¼ ìˆœë²ˆë¯¸ë£¨ê¸°</button>`;
                    }
                }

                let buttonHtml = '';
                if (mainBtn.includes('button')) { 
                    buttonHtml = `<div class="btn-group">${mainBtn}${swapBtn}</div>`;
                } else { 
                    buttonHtml = `${mainBtn}${swapBtn ? `<div class="btn-group">${swapBtn}</div>` : ''}`;
                }

                const cancelBtn = `<button class="btn-cancel-queue" onclick="window.cancelWaitingWithConfirm(${u.id})">ëŒ€ê¸° ì·¨ì†Œ</button>`;

                let timerHtml = '';

                card.innerHTML = `
                    <div class="queue-rank">${idx + 1}</div>
                    ${timerHtml}
                    <div style="margin-bottom:5px;">${getRoleBadge(u.role)}</div>
                    <strong>${u.name}</strong>
                    <div style="margin-top:5px; font-size:0.85rem;">
                        <span style="color:#d35400;">${u.completedCount}íšŒ</span>
                    </div>
                    ${buttonHtml}
                    ${cancelBtn}
                `;
                queueDiv.appendChild(card);
            });
        }

        const tbody = document.getElementById('participant-table');
        tbody.innerHTML = '';
        const allUsers = [...window.users].filter(u => u && u.id).sort((a,b) => a.id - b.id);

        allUsers.forEach(u => {
            const tr = document.createElement('tr');
            let statusHtml = '', actionBtn = '';

            if (u.status === 'idle') {
                statusHtml = '<span class="st-badge st-idle">ë¯¸ë“±ë¡</span>';
                actionBtn = `<button class="btn-apply" onclick="openRoleModal(${u.id})">ëŒ€ê¸° ì‹ ì²­</button>`;
            } else if (u.status === 'waiting') {
                statusHtml = `${getRoleBadge(u.role)} <span class="st-badge st-waiting">ëŒ€ê¸° ì¤‘</span>`;
                actionBtn = `<button class="btn-cancel" onclick="cancelWaiting(${u.id})">ì‹ ì²­ ì·¨ì†Œ</button>`;
            } else if (u.status === 'active') {
                statusHtml = `${getRoleBadge(u.role)} <span class="st-badge st-active">ì§„í–‰ ì¤‘</span>`;
                actionBtn = '-';
            }

            tr.innerHTML = `
                <td>${u.id}</td>
                <td><input type="text" class="edit-name" value="${u.name}" onchange="window.updateName(${u.id}, this.value)"></td>
                <td>
                    <input type="number" class="edit-count" value="${u.completedCount}" 
                           onchange="window.updateCompletedCount(${u.id}, this.value, this)">
                </td>
                <td>${statusHtml}</td>
                <td style="font-size:0.85rem; color:#666;">${u.startTime || '-'}</td>
                <td>
                    ${actionBtn}
                    <button class="btn-delete" onclick="window.deleteUser(${u.id})">ì‚­ì œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function getRoleBadge(role) {
        if (!role) return '';
        let className = 'role-all';
        if (role === 'í…Œì´ë„ˆ') className = 'role-tainer';
        else if (role === 'í•˜ì´ë“œ') className = 'role-hide';
        else if (role === 'í¼í¬') className = 'role-perfo';
        return `<span class="role-badge ${className}">${role}</span>`;
    }

    window.handleExcelUpload = (event) => {
        const file = event.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

            if(jsonData.length === 0) {
                alert("ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            let nextId = 1;
            if (window.users.length > 0) {
                nextId = Math.max(...window.users.map(u => u.id)) + 1;
            }

            let addCount = 0;
            jsonData.forEach((row, index) => {
                if(row.length < 1) return; 
                const name = String(row[0]).trim();
                const exists = window.users.some(u => u.name === name);
                if(!exists && name) {
                    window.users.push({
                        id: nextId++,
                        name: name,
                        completedCount: 0,
                        role: '',
                        status: 'idle',
                        waitingTime: null,
                        startTime: null
                    });
                    addCount++;
                }
            });
            window.saveData();
            alert(`${addCount}ëª…ì˜ ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            event.target.value = ''; 
        };
        reader.readAsArrayBuffer(file);
    };

    window.openRoleModal = (id) => { 
        const user = window.users.filter(u => u && u.id).find(u => u.id === id);
        if (user && user.status === 'waiting') {
            alert('ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤!\n\ní˜„ì¬ ëŒ€ê¸° ì—­í• : ' + user.role);
            return;
        }
        window.targetUserId = id; 
        document.getElementById('roleModal').style.display = 'flex'; 
    };
    window.confirmRole = (role) => {
        if (window.targetUserId) {
            const user = window.users.filter(u => u && u.id).find(u => u.id === window.targetUserId);
            if (user) {
                // ì¤‘ë³µ ëŒ€ê¸° ì²´í¬
                if (user.status === 'waiting') {
                    alert('ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤!\n\ní˜„ì¬ ëŒ€ê¸° ì—­í• : ' + user.role);
                    window.closeModal();
                    return;
                }
                
                // ë³€ê²½ ë¡œê·¸ ê¸°ë¡
                const oldRole = user.role || 'ì—†ìŒ';
                const oldStatus = user.status;
                window.logChange(user.id, user.name, 'role', oldRole, role, 'ëŒ€ê¸° ë“±ë¡ ëª¨ë‹¬');
                window.logChange(user.id, user.name, 'status', oldStatus, 'waiting', 'ëŒ€ê¸° ë“±ë¡ ëª¨ë‹¬');
                
                user.status = 'waiting';
                user.role = role;
                user.waitingTime = Date.now();
                window.saveData();
            }
        }
        window.closeModal();
    };
    window.closeModal = () => { window.targetUserId = null; document.getElementById('roleModal').style.display = 'none'; };
    window.cancelWaiting = (id) => {
        const user = window.users.filter(u => u && u.id).find(u => u.id === id);
        if (user) {
            // ë³€ê²½ ë¡œê·¸ ê¸°ë¡
            window.logChange(user.id, user.name, 'status', 'waiting', 'idle', 'ëŒ€ê¸° ì·¨ì†Œ ë²„íŠ¼');
            if (user.role) {
                window.logChange(user.id, user.name, 'role', user.role, '', 'ëŒ€ê¸° ì·¨ì†Œ ë²„íŠ¼ (ì—­í•  ì´ˆê¸°í™”)');
            }
            
            user.status = 'idle';
            user.waitingTime = null;
            user.role = '';
            user.postponedOrder = 0;
            window.saveData();
        }
    };
    window.cancelWaitingWithConfirm = (id) => {
        if(confirm('ëŒ€ê¸°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.cancelWaiting(id);
        }
    };
    window.startWork = (id) => {
        const activeUsers = window.users.filter(u => u && u.id).filter(u => u.status === 'active');
        if (activeUsers.length >= window.MAX_ACTIVE) { alert('ìŠ¬ë¡¯ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤.'); return; }
        const user = window.users.filter(u => u && u.id).find(u => u.id === id);
        if (!user) return;
        const isRoleTaken = activeUsers.some(activeUser => activeUser.role === user.role);
        if (isRoleTaken) { alert(`ğŸš« ì…ì¥ ë¶ˆê°€: í˜„ì¬ [${user.role}] í€˜ìŠ¤íŠ¸ëŠ” ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.`); return; }
        
        // ë³€ê²½ ë¡œê·¸ ê¸°ë¡
        window.logChange(user.id, user.name, 'status', user.status, 'active', 'ì…ì¥ í•˜ê¸° ë²„íŠ¼');
        
        user.status = 'active';
        user.startTime = new Date().toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        user.postponedOrder = 0;
        window.saveData();
    };
    
    // [Modified] ì¢…ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ í™•ì¸ íŒì—… ì¶”ê°€
    window.finishWork = (id) => {
        if(!confirm("í€˜ìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆë‚˜ìš”?\n(í™•ì¸ì„ ëˆ„ë¥´ë©´ ì™„ë£Œ íšŸìˆ˜ê°€ +1 ì¦ê°€í•©ë‹ˆë‹¤)")) {
            return;
        }
        
        const user = window.users.filter(u => u && u.id).find(u => u.id === id);
        if (user) {
            // ë³€ê²½ ë¡œê·¸ ê¸°ë¡
            window.logChange(user.id, user.name, 'status', 'active', 'idle', 'ì™„ë£Œ ë²„íŠ¼');
            window.logChange(user.id, user.name, 'completedCount', user.completedCount, user.completedCount + 1, 'ì™„ë£Œ ë²„íŠ¼');
            if (user.role) {
                window.logChange(user.id, user.name, 'role', user.role, '', 'ì™„ë£Œ ë²„íŠ¼ (ì—­í•  ì´ˆê¸°í™”)');
            }
            
            user.status = 'idle';
            user.completedCount += 1;
            user.startTime = null;
            user.role = ''; 
            window.saveData();
        }
    };
    
    window.postponeTurn = (currentId) => {
        const user = window.users.filter(u => u && u.id).find(u => u.id === currentId);
        if(user) {
            executePostponeLogic(user);
            window.saveData();
        }
    };

    window.addNewUser = () => {
        const nameInput = document.getElementById('new-name');
        const name = nameInput.value.trim();
        if(!name) return;
        let nextId = 1;
        if (window.users.length > 0) { nextId = Math.max(...window.users.map(u => u.id)) + 1; }
        
        window.users.push({ 
            id: nextId, name: name, 
            completedCount: 0, role: '', status: 'idle', waitingTime: null, startTime: null 
        });
        nameInput.value = '';
        window.saveData();
    };
    window.deleteUser = (id) => {
        if(confirm('ì •ë§ ì´ ì°¸ì—¬ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.users = window.users.filter(u => u && u.id).filter(u => u.id !== id);
            window.saveData();
        }
    };
    window.updateName = (id, val) => { const u = window.users.filter(u => u && u.id).find(u => u.id === id); if(u) { u.name = val; window.saveData(); } };
    
    window.clearAllData = () => { 
        if(confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')) { 
            const input = prompt("ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (input === RESET_PASSWORD) {
                window.users = []; 
                window.saveData();
                alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        } 
    };

        // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
        // ë¡œê·¸ ëª¨ë‹¬ ì—´ê¸° (ë¹„ë°€ë²ˆí˜¸ í™•ì¸)
        window.openLogModal = () => {
            const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (password === EDIT_PASSWORD) {
                document.getElementById('logModal').style.display = 'flex';
                window.refreshLogsInModal();
            } else if (password !== null) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        };
        
        // ë¡œê·¸ ëª¨ë‹¬ ë‹«ê¸°
        window.closeLogModal = () => {
            document.getElementById('logModal').style.display = 'none';
        };
        
        // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨ (ëª¨ë‹¬ ë‚´ë¶€)
        window.refreshLogsInModal = () => {
            onValue(window.changeLogRef, (snapshot) => {
                const logs = snapshot.val();
                const logTable = document.getElementById('log-table-modal');
                logTable.innerHTML = '';
                
                if (!logs) {
                    logTable.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999; padding: 50px; font-size: 1.1rem;">ğŸ“‹ ë³€ê²½ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br><br><span style="font-size:0.9rem; color:#bbb;">ì‚¬ìš©ìê°€ ì—­í•  ë³€ê²½, ì…ì¥, ì™„ë£Œ ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©´<br>ì—¬ê¸°ì— ë¡œê·¸ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</span></td></tr>';
                    return;
                }
                
                // ë¡œê·¸ë¥¼ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ìµœì‹ ìˆœ ì •ë ¬
                const logArray = Object.entries(logs).map(([key, value]) => ({
                    key: key,
                    ...value
                })).sort((a, b) => parseInt(b.key) - parseInt(a.key)).slice(0, 100); // ìµœê·¼ 100ê°œ
                
                logArray.forEach(log => {
                    const tr = document.createElement('tr');
                    
                    // í•„ë“œ ì´ë¦„ í•œê¸€í™”
                    const fieldNames = {
                        'status': 'ìƒíƒœ',
                        'role': 'ì—­í• ',
                        'completedCount': 'ì™„ë£Œ íšŸìˆ˜',
                        'postponedOrder': 'ë¯¸ë£¨ê¸° ìˆœì„œ'
                    };
                    
                    // ê°’ í•œê¸€í™”
                    const statusNames = {
                        'idle': 'ëŒ€ê¸°',
                        'waiting': 'ëŒ€ê¸°ì—´',
                        'active': 'ì§„í–‰ ì¤‘'
                    };
                    
                    const fieldName = fieldNames[log.field] || log.field;
                    let oldValue = statusNames[log.oldValue] || log.oldValue || '-';
                    let newValue = statusNames[log.newValue] || log.newValue || '-';
                    
                    tr.innerHTML = `
                        <td style="font-size:0.85rem;">${log.timestamp}</td>
                        <td><strong>${log.userName}</strong></td>
                        <td><span style="background:#3498db; color:white; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${fieldName}</span></td>
                        <td style="color:#e74c3c;">${oldValue}</td>
                        <td style="color:#27ae60;"><strong>${newValue}</strong></td>
                        <td style="font-size:0.85rem; color:#666;">${log.changedBy}</td>
                    `;
                    logTable.appendChild(tr);
                });
            }, { onlyOnce: true }); // í•œ ë²ˆë§Œ ì½ê¸°
        };
    window.handleEnter = (e) => { if(e.key === 'Enter') window.addNewUser(); };

    document.getElementById('btn-add-user').onclick = window.addNewUser;
    document.getElementById('btn-reset-all').onclick = window.clearAllData;
</script>
</body>
</html>
