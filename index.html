<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>ì—ì¹´ ì‘ìœ„ í€˜ìŠ¤íŠ¸ v4.0.1</title>
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        body { font-family: 'Segoe UI', AppleSDGothicNeo, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; display: none; }
        button { cursor: pointer; transition: 0.2s; font-family: inherit; }
        
        .btn-add { background-color: #2c3e50; color: white; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; }
        .btn-excel { background-color: #27ae60; color: white; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-reset { background-color: #e74c3c; color: white; padding: 8px 15px; border-radius: 6px; border: none; font-size: 0.9rem; }
        
        .control-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .input-wrapper { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .input-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-text { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 200px; font-size: 1rem; }

        .stats { display: flex; gap: 15px; margin-bottom: 30px; background: white; padding: 15px; border-radius: 8px; flex-wrap: wrap; justify-content: space-around; }
        .stat-box { font-weight: bold; font-size: 1rem; display: flex; align-items: center; gap: 5px; }

        section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #2c3e50; font-size: 1.3rem; margin-bottom: 15px; }
        
        .slots-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .slot { flex: 1; min-width: 280px; max-width: 400px; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; text-align: center; background: white; }
        .slot.active { border-color: #3498db; background-color: #f0f8ff; }
        .slot.empty { border: 2px dashed #bdc3c7; background-color: #fafafa; color: #aaa; min-height: 150px; justify-content: center; align-items: center; }
        .info-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; color: white; margin-bottom: 5px; background: #95a5a6; }
        .bg-green { background: #27ae60; }
        .btn-action { border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; color: white; font-size: 1rem; }
        .btn-end { background-color: #7f8c8d; }
        
        /* ğŸš¨ ìˆ˜ì •ë¨: ëŒ€ê¸°ì—´ 3ë¶„í•  ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .queue-columns { display: flex; gap: 15px; flex-wrap: wrap; width: 100%; align-items: flex-start; }
        .queue-column { flex: 1; min-width: 280px; background: #fff8e1; border: 1px solid #ffe082; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .queue-column h3 { text-align: center; margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #f1c40f; font-size: 1.1rem; }
        .queue-column.tainer { background: #fdf2e9; border-color: #f5b041; }
        .queue-column.tainer h3 { border-color: #e67e22; color: #d35400; }
        .queue-column.hide { background: #f4ecf7; border-color: #af7ac5; }
        .queue-column.hide h3 { border-color: #9b59b6; color: #8e44ad; }
        .queue-column.perfo { background: #ebf5fb; border-color: #5dade2; }
        .queue-column.perfo h3 { border-color: #3498db; color: #2980b9; }
        .queue-list { display: flex; flex-direction: column; gap: 10px; }

        .queue-card { width: 100%; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 12px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.05); display: flex; flex-direction: column; box-sizing: border-box; }
        .queue-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .queue-rank { background: #34495e; color: white; width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; flex-shrink: 0; }
        
        .btn-group { display: flex; gap: 5px; width: 100%; }
        .btn-common-style { flex: 1; border: none; padding: 8px 2px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; white-space: nowrap; display: flex; justify-content: center; align-items: center; }
        .btn-enter { background-color: #27ae60; color: white; } .btn-enter:hover { background-color: #219150; }
        .btn-swap { background-color: #d35400; color: white; } .btn-swap:hover { background-color: #e67e22; }
        .btn-disabled-card { background-color: #bdc3c7; color: #fff; cursor: not-allowed; }
        .btn-blocked-queue { background-color: #e67e22; color: #fff; cursor: not-allowed; }
        .btn-cancel-queue { margin-top: 5px; width: 100%; background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 5px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .btn-cancel-queue:hover { background: #e74c3c; color: white; }

        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 0.9rem; white-space: nowrap; }
        th { background-color: #f8f9fa; color: #555; }
        
        input.edit-name { width: 150px; padding: 6px; border: 1px solid transparent; background: transparent; font-size: 0.95rem; }
        input.edit-name:focus { border-color: #3498db; background: white; outline: none; border-radius: 4px; }
        input.edit-count { width: 60px; padding: 8px; text-align: center; border: 2px solid #f39c12; border-radius: 6px; font-weight: bold; color: #d35400; font-size: 1rem; background-color: #fffaf0; }
        input.edit-count:focus { border-color: #e67e22; background-color: #fff; outline: none; }
        
        .btn-apply, .btn-cancel, .btn-delete { padding: 6px 10px; border-radius: 4px; border: none; font-size: 0.85rem; margin-right: 2px; color: white; cursor: pointer;}
        .btn-apply { background-color: #3498db; }
        .btn-cancel { background-color: #e74c3c; }
        .btn-delete { background-color: #c0392b; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .input-wrapper { flex-direction: column; align-items: stretch; gap: 15px; }
            .input-group { width: 100%; justify-content: space-between; }
            .input-text { flex: 1; }
            .btn-add, .btn-excel { width: 100%; margin-top: 5px; }
            .slot { min-width: 100%; }
            .stats { gap: 10px; padding: 10px; }
            .stat-box { font-size: 0.9rem; }
            h1 { font-size: 1.5rem; }
            th, td { padding: 10px 5px; }
        }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .role-btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-role { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; font-size: 1rem; }
        .btn-cancel-modal { margin-top: 10px; background: transparent; border: 1px solid #ccc; padding: 8px; border-radius: 6px; color: #666; width: 100%; }
        .role-tainer { background-color: #e67e22; } .role-hide { background-color: #8e44ad; } .role-perfo { background-color: #2980b9; }
        .role-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.8rem; font-weight: bold; margin-right: 5px; vertical-align: middle; }
        .st-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .st-idle { background: #eee; color: #777; } .st-waiting { background: #fff3cd; color: #856404; } .st-active { background: #d1ecf1; color: #0c5460; }
        #loading-cover { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; font-size:1.5rem; color:#2c3e50; font-weight:bold; }
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .lock-box { background: white; padding: 30px; border-radius: 12px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 80%; max-width: 300px; }
        .lock-input { padding: 10px; font-size: 1.2rem; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; text-align: center; margin-bottom: 10px; }
        .btn-unlock { padding: 10px 20px; font-size: 1rem; background: #27ae60; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-unlock:hover { background: #219150; }
        
        .version-badge { background: #3498db; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h2 style="margin-top:0;">ğŸ”’ ì ‘ê·¼ ì œí•œ</h2>
        <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="password-input" class="lock-input" placeholder="Password" onkeypress="if(event.key==='Enter') window.checkPassword()">
        <br>
        <button class="btn-unlock" onclick="window.checkPassword()">ì… ì¥</button>
        <p id="password-error" style="color:#e74c3c; display:none; margin-top:10px; font-weight:bold;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
    </div>
</div>

<div id="loading-cover" style="display:none;">ì„œë²„ ì—°ê²° ì¤‘...</div>

<div class="container" id="main-container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <div>
            <h1 style="margin:0;">ğŸ›¡ï¸ ì—ì¹´ ì‘ìœ„ í€˜ìŠ¤íŠ¸<span class="version-badge">v4.0.1</span></h1>
            <span style="color:#27ae60; font-weight:bold; font-size:0.85rem;">â— hunterquest-fbdee ì„œë²„ ì—°ë™ë¨ (ìµœì í™” ë²„ì „)</span>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="btn-reset" id="btn-reset-count" style="background-color:#f39c12;">ì™„ë£ŒíšŸìˆ˜ì´ˆê¸°í™”</button>
            <button class="btn-reset" id="btn-reset-all">ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-box">ì „ì²´: <span id="total-cnt">0</span></div>
        <div class="stat-box" style="color:#e67e22;">â³ ëŒ€ê¸°: <span id="waiting-cnt">0</span></div>
        <div class="stat-box" style="color:#2980b9;">ğŸ”¥ ì§„í–‰: <span id="active-cnt">0</span></div>
    </div>

    <section>
        <h2>ğŸ”¥ ì§„í–‰ ì¤‘ (3 Slots)</h2>
        <div class="slots-container" id="slots-container"></div>
    </section>

    <section style="background: white;">
        <h2>â³ ëŒ€ê¸° ëª…ë‹¨ (ì—­í• ë³„ ë³´ê¸°)</h2>
        <div style="margin-bottom:15px; background:#e8f6f3; padding:10px; border-radius:4px; color:#16a085; font-size:0.9rem; line-height: 1.5;">
            <strong>ğŸš€ ë£° ì•ˆë‚´:</strong><br>
            <strong>ğŸ¯ ìˆœì„œ:</strong> 1.ì™„ë£Œ íšŸìˆ˜ ì ìŒ &gt; 2.ì‹ ì²­ ìˆœì„œ (ì„ ì°©ìˆœ)<br>
            1. í€˜ìŠ¤íŠ¸ ì¤‘ë³µ ì‹œ ì…ì¥ ë¶ˆê°€ (ê²¹ì¹˜ë©´ ìˆœë²ˆ ìœ ì§€)<br>
            2. <strong>[â–¼ ìˆœë²ˆë¯¸ë£¨ê¸°]</strong>: ê° ì—­í• ë³„ ë§¨ ë’¤ë¡œ ì´ë™ (ìˆ˜ë™)<br>
        </div>
        
        <div class="queue-columns">
            <div class="queue-column tainer">
                <h3>ğŸ”´ í…Œì´ë„ˆ ëŒ€ê¸°ì—´</h3>
                <div class="queue-list" id="queue-list-tainer"></div>
            </div>
            <div class="queue-column hide">
                <h3>ğŸŸ£ í•˜ì´ë“œ ëŒ€ê¸°ì—´</h3>
                <div class="queue-list" id="queue-list-hide"></div>
            </div>
            <div class="queue-column perfo">
                <h3>ğŸ”µ í¼í¬ ëŒ€ê¸°ì—´</h3>
                <div class="queue-list" id="queue-list-perfo"></div>
            </div>
        </div>
    </section>

    <section>
        <h2>ğŸ‘¥ ì „ì²´ ì°¸ì—¬ì ê´€ë¦¬</h2>
        <div style="margin-bottom:10px; color:#d35400; font-size:0.9rem;">
            * ì™„ë£Œ íšŸìˆ˜ ìˆ«ìë¥¼ í´ë¦­í•˜ê³  ìˆ˜ì • í›„ <strong>ì—”í„°(Enter)</strong>ë¥¼ ëˆ„ë¥´ë©´ ì €ì¥ë©ë‹ˆë‹¤.
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="8%">ID</th>
                        <th width="25%">ì´ë¦„</th>
                        <th width="12%">ì™„ë£Œ</th>
                        <th width="25%">ìƒíƒœ / í€˜ìŠ¤íŠ¸</th>
                        <th width="20%">ì‹œì‘ ì‹œê°„</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="participant-table"></tbody>
            </table>
        </div>
    </section>

    <div class="control-panel" style="text-align: center;">
        <button class="btn-excel" onclick="window.openLogModal()" style="font-size: 1rem; padding: 15px 30px; margin: 0 auto;">
            ğŸ“‹ ë³€ê²½ ë¡œê·¸ ë³´ê¸° (ê´€ë¦¬ì)
        </button>
    </div>

    <div class="control-panel">
        <div class="input-wrapper">
            <div class="input-group" style="flex: 2;">
                <strong>ğŸ‘¤ ì°¸ì—¬ì ë“±ë¡:</strong>
                <input type="text" id="new-name" class="input-text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" >
            </div>
            <button class="btn-add" id="btn-add-user" style="flex: 1;">ë“±ë¡</button>
        </div>
    </div>
</div>

<div id="roleModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0;">í€˜ìŠ¤íŠ¸ ì„ íƒ</h3>
        <p style="color:#666; font-size:0.9rem;">ì§„í–‰í•  í€˜ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
        <div class="role-btn-group">
            <button class="btn-role role-tainer" onclick="confirmRole('í…Œì´ë„ˆ')">1. í…Œì´ë„ˆ</button>
            <button class="btn-role role-hide" onclick="confirmRole('í•˜ì´ë“œ')">2. í•˜ì´ë“œ</button>
            <button class="btn-role role-perfo" onclick="confirmRole('í¼í¬')">3. í¼í¬</button>
        </div>
        <button class="btn-cancel-modal" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<div id="logModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 1200px; width: 90%; min-height: 500px; max-height: 85vh; overflow-y: auto; padding: 25px;">
        <h3 style="margin-top:0;">ğŸ“‹ ë³€ê²½ ë¡œê·¸ (ìµœê·¼ 100ê°œ)</h3>
        <button class="btn-excel" onclick="window.refreshLogsInModal()" style="margin-bottom: 15px; width: auto;">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
        <div class="table-wrapper" style="min-height: 300px;">
            <table>
                <thead>
                    <tr>
                        <th width="18%">ì‹œê°„</th>
                        <th width="12%">ì‚¬ìš©ì</th>
                        <th width="12%">ë³€ê²½ í•­ëª©</th>
                        <th width="15%">ì´ì „ ê°’</th>
                        <th width="15%">ìƒˆ ê°’</th>
                        <th width="15%">ë³€ê²½ì</th>
                    </tr>
                </thead>
                <tbody id="log-table-modal"></tbody>
            </table>
        </div>
        <button class="btn-cancel-modal" onclick="window.closeLogModal()" style="margin-top: 15px;">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, runTransaction, query, orderByKey, limitToLast } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // ========================================
    // ìƒìˆ˜ ì •ì˜ (Constants)
    // ========================================
    const CONSTANTS = {
        VERSION: "4.0.1",
        MAX_ACTIVE_SLOTS: 3,
        LOG_DISPLAY_COUNT: 100,
        SITE_PASSWORD: "1234",
        RESET_PASSWORD: "4223",
        EDIT_PASSWORD: "9876"
    };

    const firebaseConfig = {
        apiKey: "AIzaSyBJ9CRer5FEjA1_yZ5g1jBypaX_3Cpqqyo",
        authDomain: "hunterquest-fbdee.firebaseapp.com",
        databaseURL: "https://hunterquest-fbdee-default-rtdb.firebaseio.com",
        projectId: "hunterquest-fbdee",
        storageBucket: "hunterquest-fbdee.firebasestorage.app",
        messagingSenderId: "999017602063",
        appId: "1:999017602063:web:711b798bb7405ddbfe577a",
        measurementId: "G-13WEG56NZR"
    };

    // ========================================
    // í—¬í¼ í•¨ìˆ˜
    // ========================================
    const getValidUsers = (users) => {
        if (!users) return [];
        return Array.isArray(users) ? users.filter(u => u && u.id) : Object.values(users).filter(u => u && u.id);
    };

    const generateUniqueId = (existingUsers) => {
        if (existingUsers.length === 0) return 1;
        return Math.max(...existingUsers.map(u => u.id || 0)) + 1;
    };

    /**
     * ğŸš¨ ë£° ìˆ˜ì •ë¨: ë” ì´ìƒ 'ì—­í• 'ì„ ê¸°ì¤€ìœ¼ë¡œ ê°•ì œ ì •ë ¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (UI 3ë¶„í• ë¡œ ë¶„ë¦¬í–ˆê¸° ë•Œë¬¸)
     * ì˜¤ì§ ê³µì •í•œ ë£°(ë¯¸ë£¨ê¸° -> ì™„ë£Œ íšŸìˆ˜ -> ì„ ì°©ìˆœ)ë§Œ ì ìš©í•©ë‹ˆë‹¤.
     */
    const sortWaitingUsers = (users) => {
        return users.sort((a, b) => {
            // 1. ë¯¸ë£¨ê¸° ì—¬ë¶€ (ë¯¸ë£¨ê¸° ì•ˆí•œ ì‚¬ëŒì´ ìš°ì„ !)
            const aPostponed = a.isPostponed || false;
            const bPostponed = b.isPostponed || false;
            if (aPostponed !== bPostponed) return aPostponed ? 1 : -1; 
            
            // 2. ì™„ë£Œ íšŸìˆ˜ ì ì€ ìˆœ
            if (a.completedCount !== b.completedCount) return a.completedCount - b.completedCount;
            
            // 3. ì‹ ì²­ ì‹œê°„ ë¹ ë¥¸ ìˆœ
            return (a.waitingTime || 0) - (b.waitingTime || 0);
        });
    };

    const getRoleBadge = (role) => {
        if (!role) return '';
        let className = 'role-all';
        if (role === 'í…Œì´ë„ˆ') className = 'role-tainer';
        else if (role === 'í•˜ì´ë“œ') className = 'role-hide';
        else if (role === 'í¼í¬') className = 'role-perfo';
        return `<span class="role-badge ${className}">${role}</span>`;
    };

    /**
     * íƒ€ì„ìŠ¤íƒ¬í”„ì¸ì§€ íŒë³„ (ìˆ«ì ë˜ëŠ” ìˆ«ìí˜• ë¬¸ìì—´ "1740000000000")
     */
    const isTimestamp = (val) => {
        if (typeof val === 'number') return true;
        if (typeof val === 'string' && /^\d{10,}$/.test(val)) return true;
        return false;
    };

    /**
     * UTC íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ë³´ëŠ” ì‚¬ëŒì˜ ë¡œì»¬ ì‹œê°„ "HH:MM:SS"ë¡œ ë³€í™˜
     * (êµ¬ í¬ë§· "HH:MM:SS" ë¬¸ìì—´ë„ ê·¸ëŒ€ë¡œ ë°˜í™˜)
     */
    const formatStartTime = (startTime) => {
        if (!startTime) return '-';
        if (isTimestamp(startTime)) {
            const d = new Date(Number(startTime));
            return d.toLocaleTimeString('ko-KR', { hour12: false, timeZone: 'Asia/Seoul' });
        }
        return startTime; // êµ¬ í¬ë§· ë¬¸ìì—´ì€ ê·¸ëŒ€ë¡œ
    };

    /**
     * ê²½ê³¼ ì‹œê°„ ê³„ì‚° (UTC íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜, êµ¬ í¬ë§· í•˜ìœ„ í˜¸í™˜)
     */
    const getElapsedTime = (startTime) => {
        if (!startTime) return '';
        try {
            let diffMs;
            if (isTimestamp(startTime)) {
                // ì‹ ê·œ í¬ë§·: UTC íƒ€ì„ìŠ¤íƒ¬í”„ (ìˆ«ì ë˜ëŠ” DOMì—ì„œ ì½ì€ ìˆ«ìí˜• ë¬¸ìì—´)
                diffMs = Date.now() - Number(startTime);
            } else {
                // êµ¬ í¬ë§·: "HH:MM:SS" ë¬¸ìì—´ (ê¸°ì¡´ ë°ì´í„° í˜¸í™˜ìš©)
                const match = startTime.match(/^(\d{1,2}):(\d{2}):(\d{2})$/);
                if (!match) return '';
                const now = new Date();
                const today = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                let startDateTime = new Date(`${today}T${startTime}`);
                if (isNaN(startDateTime.getTime())) return '';
                if (startDateTime > now) startDateTime.setDate(startDateTime.getDate() - 1);
                diffMs = now - startDateTime;
            }
            
            const diffMinutes = Math.floor(diffMs / 60000);
            if (diffMinutes < 1) return 'ë°©ê¸ˆ ì‹œì‘';
            else if (diffMinutes < 60) return `${diffMinutes}ë¶„ ê²½ê³¼`;
            else return `${Math.floor(diffMinutes / 60)}ì‹œê°„ ${diffMinutes % 60}ë¶„ ê²½ê³¼`;
        } catch (error) {
            return '';
        }
    };

    // ========================================
    // Firebase ì´ˆê¸°í™”
    // ========================================
    window.checkPassword = () => {
        const input = document.getElementById('password-input').value;
        const errorMsg = document.getElementById('password-error');
        if (input === CONSTANTS.SITE_PASSWORD) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('loading-cover').style.display = 'flex';
            startFirebase(); 
        } else {
            errorMsg.style.display = 'block';
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }
    };

    function startFirebase() {
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'eka_quest_users');
        window.changeLogRef = ref(db, 'eka_change_logs');

        window.users = [];
        window.MAX_ACTIVE = CONSTANTS.MAX_ACTIVE_SLOTS;
        window.targetUserId = null;
        let isSaving = false;
        let logCounter = 0;
        
        window.logChange = (userId, userName, field, oldValue, newValue, changedBy = 'ì‹œìŠ¤í…œ') => {
            const timestamp = new Date().toLocaleString('ko-KR', { hour12: false, timeZone: 'Asia/Seoul' });
            const logEntry = { timestamp, userId, userName, field, oldValue: String(oldValue), newValue: String(newValue), changedBy };
            const uniqueKey = Date.now() + '_' + (logCounter++);
            set(ref(db, 'eka_change_logs/' + uniqueKey), logEntry).catch(e => console.error('ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', e));
        };

        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            window.users = data ? getValidUsers(data) : [];
            render(); // Firebase ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§Œ ë Œë”ë§
            document.getElementById('loading-cover').style.display = 'none';
        }, (error) => {
            alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨:\n' + error.message);
            document.getElementById('loading-cover').style.display = 'none';
        });

        window.saveData = (updateFunction) => {
            if (isSaving) return Promise.resolve();
            isSaving = true;
            return runTransaction(dbRef, (currentData) => {
                let data = currentData ? getValidUsers(currentData) : [];
                if (updateFunction) data = updateFunction(data);
                return data.map(user => ({ ...user, postponedOrder: user.postponedOrder ?? 0 }));
            }).then((res) => {
                isSaving = false;
                return res;
            }).catch((err) => {
                isSaving = false;
                alert('ì €ì¥ ì˜¤ë¥˜: ' + err.message);
                throw err;
            });
        };
        
        // í™œì„± ìŠ¬ë¡¯ì˜ ê²½ê³¼ ì‹œê°„ ì—…ë°ì´íŠ¸ (1ì´ˆë§ˆë‹¤)
        setInterval(() => {
            const elapsedElements = document.querySelectorAll('.elapsed-time-display');
            elapsedElements.forEach(el => {
                const startTime = el.getAttribute('data-start-time');
                if (startTime) {
                    const elapsedText = getElapsedTime(startTime);
                    el.innerHTML = elapsedText ? `â±ï¸ ${elapsedText}` : '';
                }
            });
        }, 1000);
    }

    // ========================================
    // UI ë Œë”ë§
    // ========================================
    function render() {
        const users = getValidUsers(window.users);
        const waitingUsers = sortWaitingUsers(users.filter(u => u.status === 'waiting'));
        const activeUsers = users.filter(u => u.status === 'active');
        const currentRoles = activeUsers.map(u => u.role);

        document.getElementById('total-cnt').innerText = users.length;
        document.getElementById('waiting-cnt').innerText = waitingUsers.length;
        document.getElementById('active-cnt').innerText = activeUsers.length;

        renderActiveSlots(activeUsers);
        renderQueueColumns(waitingUsers, currentRoles, activeUsers.length);
        renderParticipantTable(users);
    }
    
    function renderActiveSlots(activeUsers) {
        const slotsDiv = document.getElementById('slots-container');
        slotsDiv.innerHTML = '';
        
        for (let i = 0; i < CONSTANTS.MAX_ACTIVE_SLOTS; i++) {
            const user = activeUsers[i];
            const div = document.createElement('div');
            
            if (user) {
                const elapsedTime = getElapsedTime(user.startTime);
                const displayTime = formatStartTime(user.startTime);
                const elapsedHTML = `<br><span class="elapsed-time-display" data-start-time="${user.startTime}" style="color:#e67e22; font-weight:bold; font-size:0.9rem;">${elapsedTime ? 'â±ï¸ ' + elapsedTime : ''}</span>`;
                
                div.className = 'slot active';
                div.innerHTML = `
                    <div>
                        <span class="info-badge bg-green">${user.completedCount}íšŒ ì™„ë£Œ</span>
                        <h3 style="margin:10px 0;">${getRoleBadge(user.role)} ${user.name}</h3>
                        <small style="color:#888">${displayTime} ì‹œì‘${elapsedHTML}</small>
                    </div>
                    <button class="btn-action btn-end" onclick="finishWork(${user.id})">ì¢…ë£Œ (íšŸìˆ˜ +1)</button>
                `;
            } else {
                div.className = 'slot empty';
                div.innerHTML = `<h3>ë¹ˆ ìŠ¬ë¡¯ ${i + 1}</h3><div style="font-size:0.9rem;">ì…ì¥ ëŒ€ê¸° ì¤‘...</div>`;
            }
            slotsDiv.appendChild(div);
        }
    }

    /**
     * ğŸš¨ ëŒ€ê¸°ì—´ 3ë¶„í•  ë Œë”ë§ í•¨ìˆ˜
     */
    function renderQueueColumns(waitingUsers, currentRoles, activeCount) {
        const listTainer = document.getElementById('queue-list-tainer');
        const listHide = document.getElementById('queue-list-hide');
        const listPerfo = document.getElementById('queue-list-perfo');
        
        listTainer.innerHTML = ''; listHide.innerHTML = ''; listPerfo.innerHTML = '';
        
        const hasEmptySlot = activeCount < CONSTANTS.MAX_ACTIVE_SLOTS;
        const queuedRoles = new Set(); 
        
        // ì—­í• ë³„ ìˆœìœ„ ì¶”ì 
        const roleRanks = { 'í…Œì´ë„ˆ': 0, 'í•˜ì´ë“œ': 0, 'í¼í¬': 0 };

        waitingUsers.forEach((u) => {
            if (!u.role) return;
            
            roleRanks[u.role]++;
            const localRank = roleRanks[u.role];
            
            const card = document.createElement('div');
            card.className = 'queue-card';
            
            const isBlockedByActive = currentRoles.includes(u.role);
            const isBlockedByQueue = queuedRoles.has(u.role);
            queuedRoles.add(u.role);

            // ì…ì¥ ë²„íŠ¼ íŒë³„
            let mainBtn = '';
            if (!hasEmptySlot) {
                mainBtn = `<button disabled class="btn-common-style btn-disabled-card">ìŠ¬ë¡¯ ê½‰ì°¸</button>`;
            } else if (isBlockedByActive) {
                mainBtn = `<button disabled class="btn-common-style btn-disabled-card" style="color:#e74c3c;">â›” ì§„í–‰ ì¤‘</button>`;
            } else if (isBlockedByQueue) {
                mainBtn = `<button disabled class="btn-common-style btn-blocked-queue">âœ‹ ëŒ€ê¸° ì¤‘</button>`;
            } else {
                mainBtn = `<button class="btn-common-style btn-enter" onclick="startWork(${u.id})">ì…ì¥ í•˜ê¸°</button>`;
            }

            // ìˆœë²ˆ ë¯¸ë£¨ê¸° (ê°™ì€ ì—­í•  ë‚´ 2ëª… ì´ìƒì¼ ë•Œ, 1ìˆœìœ„ë§Œ ê°€ëŠ¥)
            let swapBtn = '';
            const sameRoleWaiting = waitingUsers.filter(user => user.role === u.role);
            if (sameRoleWaiting.length >= 2) {
                const isFirstInRole = sameRoleWaiting[0].id === u.id;
                if (isFirstInRole) {
                    swapBtn = `<button class="btn-common-style btn-swap" onclick="window.postponeTurn(${u.id})">â–¼ ë§¨ë’¤ë¡œ</button>`;
                } else {
                    swapBtn = `<button class="btn-common-style btn-swap" disabled style="opacity:0.5; cursor:not-allowed; background:#cbd5e0;">â–¼ ë§¨ë’¤ë¡œ</button>`;
                }
            }

            let buttonHtml = `<div class="btn-group">${mainBtn}${swapBtn}</div>`;
            
            card.innerHTML = `
                <div class="queue-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div class="queue-rank">${localRank}</div>
                        <div>
                            <h4 style="margin:0;">${u.name}</h4>
                            <small style="color:#888;">ì™„ë£Œ ${u.completedCount}íšŒ</small>
                        </div>
                    </div>
                </div>
                <div style="margin-top:5px;">
                    ${buttonHtml}
                    <button class="btn-cancel-queue" onclick="window.cancelWaitingWithConfirm(${u.id})">ëŒ€ê¸° ì·¨ì†Œ</button>
                </div>
            `;
            
            // ì˜¬ë°”ë¥¸ ì»¬ëŸ¼ì— ë°•ìŠ¤ ì¶”ê°€
            if (u.role === 'í…Œì´ë„ˆ') listTainer.appendChild(card);
            else if (u.role === 'í•˜ì´ë“œ') listHide.appendChild(card);
            else if (u.role === 'í¼í¬') listPerfo.appendChild(card);
        });
        
        // ë¹„ì–´ìˆëŠ” ì»¬ëŸ¼ ì•ˆë‚´ ë¬¸êµ¬
        if (roleRanks['í…Œì´ë„ˆ'] === 0) listTainer.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px 0;">ëŒ€ê¸°ì ì—†ìŒ</div>';
        if (roleRanks['í•˜ì´ë“œ'] === 0) listHide.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px 0;">ëŒ€ê¸°ì ì—†ìŒ</div>';
        if (roleRanks['í¼í¬'] === 0) listPerfo.innerHTML = '<div style="color:#aaa; text-align:center; padding:20px 0;">ëŒ€ê¸°ì ì—†ìŒ</div>';
    }

    function renderParticipantTable(users) {
        const tbody = document.getElementById('participant-table');
        tbody.innerHTML = '';
        
        const allUsers = [...users].sort((a, b) => {
            const aHasCompleted = a.completedCount > 0 ? 0 : 1;
            const bHasCompleted = b.completedCount > 0 ? 0 : 1;
            if (aHasCompleted !== bHasCompleted) return aHasCompleted - bHasCompleted;
            return a.id - b.id;
        });

        allUsers.forEach(u => {
            const tr = document.createElement('tr');
            let statusHtml = '', actionBtn = '';

            if (u.status === 'idle') {
                statusHtml = '<span class="st-badge st-idle">ë¯¸ë“±ë¡</span>';
                actionBtn = `<button class="btn-apply" onclick="openRoleModal(${u.id})">ëŒ€ê¸° ì‹ ì²­</button>`;
            } else if (u.status === 'waiting') {
                statusHtml = `${getRoleBadge(u.role)} <span class="st-badge st-waiting">ëŒ€ê¸° ì¤‘</span>`;
                actionBtn = `<button class="btn-cancel" onclick="cancelWaiting(${u.id})">ì‹ ì²­ ì·¨ì†Œ</button>`;
            } else if (u.status === 'active') {
                statusHtml = `${getRoleBadge(u.role)} <span class="st-badge st-active">ì§„í–‰ ì¤‘</span>`;
                actionBtn = '-';
            }
            
            const rowOpacity = (u.completedCount === 0) ? 'opacity: 0.6;' : '';

            tr.innerHTML = `
                <td style="${rowOpacity}">${u.id}</td>
                <td style="${rowOpacity}"><input type="text" class="edit-name" value="${u.name}" onchange="window.updateName(${u.id}, this.value)"></td>
                <td style="${rowOpacity}">
                    <input type="number" class="edit-count" value="${u.completedCount}" onchange="window.updateCompletedCount(${u.id}, this.value, this)">
                </td>
                <td style="${rowOpacity}">${statusHtml}</td>
                <td style="font-size:0.85rem; color:#666; ${rowOpacity}">${formatStartTime(u.startTime)}</td>
                <td>
                    ${actionBtn}
                    <button class="btn-delete" onclick="window.deleteUser(${u.id})">ì‚­ì œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ========================================
    // ì‚¬ìš©ì ì•¡ì…˜
    // ========================================
    window.updateCompletedCount = (id, newVal, inputEl) => {
        const validUsers = getValidUsers(window.users);
        const user = validUsers.find(u => u.id === id);
        if (!user || user.completedCount == newVal) return;

        const originalVal = user.completedCount;
        const parsedVal = parseInt(newVal);

        if (isNaN(parsedVal) || parsedVal < 0) {
            alert("ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            inputEl.value = originalVal; return;
        }

        if (prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:") === CONSTANTS.EDIT_PASSWORD) {
            window.saveData((currentData) => {
                const validData = getValidUsers(currentData);
                const currentUser = validData.find(u => u.id === id);
                if (currentUser) {
                    window.logChange(id, user.name, 'completedCount', currentUser.completedCount, parsedVal, 'ê´€ë¦¬ì ì§ì ‘ ìˆ˜ì •');
                    currentUser.completedCount = parsedVal;
                }
                return validData;
            }).then(() => alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."));
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            inputEl.value = originalVal;
        }
    };


    window.openRoleModal = (id) => { 
        const validUsers = getValidUsers(window.users);
        const user = validUsers.find(u => u.id === id);
        if (user && user.status === 'waiting') {
            alert('ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤!\n\ní˜„ì¬ ëŒ€ê¸° ì—­í• : ' + user.role);
            return;
        }
        window.targetUserId = id; 
        document.getElementById('roleModal').style.display = 'flex'; 
    };
    
    window.confirmRole = (role) => {
        if (!role) return alert('í€˜ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
        
        // ì‚¬ì „ ê²€ì¦ (íŠ¸ëœì­ì…˜ ë°–)
        const localUser = getValidUsers(window.users).find(u => u.id === window.targetUserId);
        if (localUser && localUser.status === 'waiting') {
            alert('ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤!\n\ní˜„ì¬ ëŒ€ê¸° ì—­í• : ' + localUser.role);
            window.closeModal();
            return;
        }
        
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const user = validData.find(u => u.id === window.targetUserId);
            if (user) {
                if (user.status === 'waiting') return validData; // ì¡°ìš©íˆ ë°˜í™˜
                window.logChange(user.id, user.name, 'action', '', `${role} ëŒ€ê¸°ì—´ ë“±ë¡`, 'ëŒ€ê¸° ë“±ë¡');
                user.status = 'waiting'; user.role = role; user.waitingTime = Date.now(); user.postponedOrder = 0;
            }
            return validData;
        });
        window.closeModal();
    };
    
    window.closeModal = () => { window.targetUserId = null; document.getElementById('roleModal').style.display = 'none'; };
    
    window.cancelWaiting = (id) => {
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const user = validData.find(u => u.id === id);
            if (user) {
                window.logChange(user.id, user.name, 'action', '', `${user.role || 'ëŒ€ê¸°'} ì·¨ì†Œ`, 'ëŒ€ê¸° ì·¨ì†Œ');
                user.status = 'idle'; user.waitingTime = null; user.role = ''; user.postponedOrder = 0; user.isPostponed = false;
            }
            return validData;
        });
    };
    
    window.cancelWaitingWithConfirm = (id) => { if (confirm('ëŒ€ê¸°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) window.cancelWaiting(id); };
    
    window.startWork = (id) => {
        // ì‚¬ì „ ê²€ì¦ (íŠ¸ëœì­ì…˜ ë°–)
        const localUsers = getValidUsers(window.users);
        const localActive = localUsers.filter(u => u.status === 'active');
        if (localActive.length >= CONSTANTS.MAX_ACTIVE_SLOTS) { alert('ìŠ¬ë¡¯ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤.'); return; }
        
        const localUser = localUsers.find(u => u.id === id);
        if (!localUser || !localUser.role) return;
        if (localActive.some(au => au.role === localUser.role)) { alert(`ğŸš« [${localUser.role}] í€˜ìŠ¤íŠ¸ëŠ” ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.`); return; }
        
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const activeUsers = validData.filter(u => u.status === 'active');
            if (activeUsers.length >= CONSTANTS.MAX_ACTIVE_SLOTS) return validData;
            
            const user = validData.find(u => u.id === id);
            if (!user || !user.role) return validData;
            if (activeUsers.some(au => au.role === user.role)) return validData;
            
            window.logChange(user.id, user.name, 'action', '', `${user.role} ì…ì¥`, 'ì…ì¥');
            user.status = 'active'; 
            user.startTime = Date.now();
            user.postponedOrder = 0; user.isPostponed = false;
            return validData;
        });
    };
    
    window.finishWork = (id) => {
        if (!confirm("ì™„ë£Œ íšŸìˆ˜ê°€ +1 ì¦ê°€í•©ë‹ˆë‹¤. í€˜ìŠ¤íŠ¸ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const user = validData.find(u => u.id === id);
            if (user) {
                user.completedCount += 1;
                window.logChange(user.id, user.name, 'action', '', `${user.role} ì™„ë£Œ (${user.completedCount}íšŒ)`, 'ì™„ë£Œ');
                user.status = 'idle'; user.startTime = null; user.role = ''; user.postponedOrder = 0; user.isPostponed = false;
            }
            return validData;
        });
    };
    
    window.postponeTurn = (currentId) => {
        // ì‚¬ì „ ê²€ì¦ (íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ë¡œì»¬ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œ ì²´í¬)
        const localUser = window.users.find(u => u && u.id === currentId);
        if (!localUser || !localUser.role) return;
        
        const localSameRole = window.users
            .filter(u => u && u.status === 'waiting' && u.role === localUser.role);
        const localSorted = sortWaitingUsers([...localSameRole]);
        
        if (localSorted.length < 2 || localSorted[0].id !== currentId) {
            alert('ë¯¸ë£¨ê¸°ëŠ” ì²« ë²ˆì§¸ ëŒ€ê¸°ìë§Œ ê°€ëŠ¥í•˜ë©°, ê°™ì€ ì—­í•  ëŒ€ê¸°ìê°€ 2ëª… ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        
        // ê²€ì¦ í†µê³¼ í›„ íŠ¸ëœì­ì…˜ ì‹¤í–‰ (alert ì—†ì´ ë°ì´í„°ë§Œ ìˆ˜ì •)
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const user = validData.find(u => u && u.id === currentId);
            if (!user || !user.role) return validData;
            
            const sameRoleWaiting = validData
                .filter(u => u && u.status === 'waiting' && u.role === user.role);
            const sorted = sortWaitingUsers([...sameRoleWaiting]);
            
            // íŠ¸ëœì­ì…˜ ë‚´ ì¬ê²€ì¦ (ì¡°ê±´ ì•ˆ ë§ìœ¼ë©´ ì¡°ìš©íˆ ì›ë³¸ ë°˜í™˜)
            if (sorted.length < 2 || sorted[0].id !== currentId) return validData;
            
            user.isPostponed = true;
            user.waitingTime = Date.now();
            window.logChange(user.id, user.name, 'action', '', `${user.role} ìˆœë²ˆ ë§¨ë’¤ë¡œ`, 'ë¯¸ë£¨ê¸°');
            return validData;
        });
    };

    window.addNewUser = () => {
        const name = document.getElementById('new-name').value.trim();
        if (!name) return alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        if (getValidUsers(window.users).some(u => u.name === name)) return alert(`"${name}"ì€(ëŠ”) ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.`);
        
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            if (validData.some(u => u.name === name)) return validData;
            validData.push({ id: generateUniqueId(validData), name: name, completedCount: 0, role: '', status: 'idle', waitingTime: null, startTime: null, postponedOrder: 0, isPostponed: false });
            return validData;
        }).then(() => document.getElementById('new-name').value = '');
    };
    
    window.deleteUser = (id) => { if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) window.saveData((currentData) => getValidUsers(currentData).filter(u => u.id !== id)); };
    window.updateName = (id, val) => {
        const trimmed = val.trim();
        if (!trimmed) {
            alert('ì´ë¦„ì€ ë¹ˆì¹¸ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            const original = getValidUsers(window.users).find(u => u.id === id);
            if (original) document.querySelector(`input.edit-name[onchange*="(${id},"]`).value = original.name;
            return;
        }
        window.saveData((currentData) => { const validData = getValidUsers(currentData); const u = validData.find(u => u.id === id); if (u) u.name = trimmed; return validData; });
    };
    
    window.resetCompletedCounts = () => {
        if (!confirm('ëª¨ë“  ì°¸ì—¬ìì˜ ì™„ë£Œ íšŸìˆ˜ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì°¸ì—¬ì ëª©ë¡ê³¼ ìƒíƒœëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) return;
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if (pw === CONSTANTS.EDIT_PASSWORD) {
            window.saveData((currentData) => {
                const validData = getValidUsers(currentData);
                validData.forEach(u => {
                    if (u.completedCount > 0) {
                        window.logChange(u.id, u.name, 'completedCount', u.completedCount, 0, 'ì¼ê´„ ì´ˆê¸°í™”');
                        u.completedCount = 0;
                    }
                });
                return validData;
            }).then(() => alert("ëª¨ë“  ì™„ë£Œ íšŸìˆ˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."));
        } else if (pw !== null) {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }
    };

    window.clearAllData = () => { 
        if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
            if (prompt("ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸:") === CONSTANTS.RESET_PASSWORD) {
                window.saveData(() => []).then(() => alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."));
            } else alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        } 
    };

    window.openLogModal = () => {
        if (prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:') === CONSTANTS.EDIT_PASSWORD) {
            document.getElementById('logModal').style.display = 'flex'; window.refreshLogsInModal();
        } else alert('ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜');
    };
    window.closeLogModal = () => { document.getElementById('logModal').style.display = 'none'; };
    
    window.refreshLogsInModal = () => {
        // ì„œë²„ì—ì„œ ìµœê·¼ 100ê°œë§Œ ê°€ì ¸ì˜¤ëŠ” ì¿¼ë¦¬ (ì „ì²´ ë‹¤ìš´ë¡œë“œ ë°©ì§€)
        const logsQuery = query(window.changeLogRef, orderByKey(), limitToLast(CONSTANTS.LOG_DISPLAY_COUNT));
        onValue(logsQuery, (snapshot) => {
            const logs = snapshot.val();
            const logTable = document.getElementById('log-table-modal');
            logTable.innerHTML = '';
            if (!logs) return logTable.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 50px;">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            
            Object.entries(logs).map(([key, value]) => ({key, ...value})).sort((a, b) => parseInt(b.key) - parseInt(a.key)).forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${log.timestamp}</td><td><strong>${log.userName}</strong></td><td><span style="background:#3498db; color:white; padding:2px 6px; border-radius:4px;">${log.field}</span></td><td style="color:#e74c3c;">${log.oldValue || '-'}</td><td style="color:#27ae60;"><strong>${log.newValue || '-'}</strong></td><td>${log.changedBy}</td>`;
                logTable.appendChild(tr);
            });
        }, { onlyOnce: true });
    };

    document.getElementById('btn-add-user').onclick = window.addNewUser;
    document.getElementById('btn-reset-count').onclick = window.resetCompletedCounts;
    document.getElementById('btn-reset-all').onclick = window.clearAllData;
    document.getElementById('new-name').addEventListener('keypress', (e) => { if(e.key==='Enter') window.addNewUser(); });
</script>
</body>
</html>
