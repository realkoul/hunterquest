<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:,">
    <title>ì—ì¹´ ì‘ìœ„ í€˜ìŠ¤íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ v3.5.5</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        body { font-family: 'Segoe UI', AppleSDGothicNeo, sans-serif; background-color: #f0f2f5; margin: 0; padding: 15px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; display: none; }
        button { cursor: pointer; transition: 0.2s; font-family: inherit; }
        
        .btn-add { background-color: #2c3e50; color: white; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; }
        .btn-excel { background-color: #27ae60; color: white; padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-reset { background-color: #e74c3c; color: white; padding: 8px 15px; border-radius: 6px; border: none; font-size: 0.9rem; }
        
        .control-panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .input-wrapper { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; }
        .input-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .input-text { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 200px; font-size: 1rem; }

        .stats { display: flex; gap: 15px; margin-bottom: 30px; background: white; padding: 15px; border-radius: 8px; flex-wrap: wrap; justify-content: space-around; }
        .stat-box { font-weight: bold; font-size: 1rem; display: flex; align-items: center; gap: 5px; }

        section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #2c3e50; font-size: 1.3rem; margin-bottom: 15px; }
        
        .slots-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .slot { flex: 1; min-width: 280px; max-width: 400px; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; text-align: center; background: white; }
        .slot.active { border-color: #3498db; background-color: #f0f8ff; }
        .slot.empty { border: 2px dashed #bdc3c7; background-color: #fafafa; color: #aaa; min-height: 150px; justify-content: center; align-items: center; }
        .info-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; color: white; margin-bottom: 5px; background: #95a5a6; }
        .bg-green { background: #27ae60; }
        .btn-action { border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; color: white; font-size: 1rem; }
        .btn-end { background-color: #7f8c8d; }
        
        .queue-container { width: 100%; }
        .queue-list { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .queue-card { width: 100%; max-width: 180px; background: #fff8e1; border: 1px solid #ffe082; border-radius: 8px; padding: 15px; text-align: center; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: space-between; }
        .queue-rank { position: absolute; top: -10px; left: -10px; background: #ff9800; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1rem; box-shadow: 0 2px 2px rgba(0,0,0,0.2); }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; width: 100%; }
        .btn-common-style { flex: 1; width: 0; border: none; padding: 8px 2px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; white-space: nowrap; display: flex; justify-content: center; align-items: center; }
        .btn-enter { background-color: #27ae60; color: white; } .btn-enter:hover { background-color: #219150; }
        .btn-swap { background-color: #d35400; color: white; } .btn-swap:hover { background-color: #e67e22; }
        .btn-disabled-card { background-color: #bdc3c7; color: #fff; cursor: not-allowed; }
        .btn-blocked-queue { background-color: #e67e22; color: #fff; cursor: not-allowed; }
        .btn-cancel-queue { margin-top: 5px; width: 100%; background: transparent; border: 1px solid #e74c3c; color: #e74c3c; padding: 5px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .btn-cancel-queue:hover { background: #e74c3c; color: white; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 0.9rem; white-space: nowrap; }
        th { background-color: #f8f9fa; color: #555; }
        
        input.edit-name { width: 150px; padding: 6px; border: 1px solid transparent; background: transparent; font-size: 0.95rem; }
        input.edit-name:focus { border-color: #3498db; background: white; outline: none; border-radius: 4px; }
        input.edit-count { width: 60px; padding: 8px; text-align: center; border: 2px solid #f39c12; border-radius: 6px; font-weight: bold; color: #d35400; font-size: 1rem; background-color: #fffaf0; }
        input.edit-count:focus { border-color: #e67e22; background-color: #fff; outline: none; }
        
        .btn-apply, .btn-cancel, .btn-delete { padding: 6px 10px; border-radius: 4px; border: none; font-size: 0.85rem; margin-right: 2px; color: white; cursor: pointer;}
        .btn-apply { background-color: #3498db; }
        .btn-cancel { background-color: #e74c3c; }
        .btn-delete { background-color: #c0392b; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .input-wrapper { flex-direction: column; align-items: stretch; gap: 15px; }
            .input-group { width: 100%; justify-content: space-between; }
            .input-text { flex: 1; }
            .btn-add, .btn-excel { width: 100%; margin-top: 5px; }
            .slot { min-width: 100%; }
            .queue-card { max-width: 47%; flex: 1 1 40%; }
            .stats { gap: 10px; padding: 10px; }
            .stat-box { font-size: 0.9rem; }
            h1 { font-size: 1.5rem; }
            th, td { padding: 10px 5px; }
        }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .role-btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-role { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; font-size: 1rem; }
        .btn-cancel-modal { margin-top: 10px; background: transparent; border: 1px solid #ccc; padding: 8px; border-radius: 6px; color: #666; width: 100%; }
        .role-tainer { background-color: #e74c3c; } .role-hide { background-color: #8e44ad; } .role-perfo { background-color: #2980b9; }
        .role-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.8rem; font-weight: bold; margin-right: 5px; vertical-align: middle; }
        .st-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .st-idle { background: #eee; color: #777; } .st-waiting { background: #fff3cd; color: #856404; } .st-active { background: #d1ecf1; color: #0c5460; }
        #loading-cover { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; font-size:1.5rem; color:#2c3e50; font-weight:bold; }
        #lock-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .lock-box { background: white; padding: 30px; border-radius: 12px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 80%; max-width: 300px; }
        .lock-input { padding: 10px; font-size: 1.2rem; border: 1px solid #ddd; border-radius: 6px; width: 100%; box-sizing: border-box; text-align: center; margin-bottom: 10px; }
        .btn-unlock { padding: 10px 20px; font-size: 1rem; background: #27ae60; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-unlock:hover { background: #219150; }
        
        /* ë°°ë„ˆ ìŠ¤íƒ€ì¼ì€ ì¸ë¼ì¸ìœ¼ë¡œ ì ìš©ë¨ */
        .improved-badge { background: #27ae60; color: white; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-box">
        <h2 style="margin-top:0;">ğŸ”’ ì ‘ê·¼ ì œí•œ</h2>
        <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="password" id="password-input" class="lock-input" placeholder="Password" onkeypress="if(event.key==='Enter') window.checkPassword()">
        <br>
        <button class="btn-unlock" onclick="window.checkPassword()">ì… ì¥</button>
        <p id="password-error" style="color:#e74c3c; display:none; margin-top:10px; font-weight:bold;">ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.</p>
    </div>
</div>

<div id="loading-cover" style="display:none;">ì„œë²„ ì—°ê²° ì¤‘...</div>

<div class="container" id="main-container">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1rem; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        ğŸ›¡ï¸ ì—ì¹´ ì‘ìœ„ í€˜ìŠ¤íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ
        <span class="improved-badge" style="background: #27ae60;">âœ¨ v3.5.5</span>
    </div>
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
        <div>
            <h1 style="margin:0;">ğŸ›¡ï¸ ì—ì¹´ ì‘ìœ„ í€˜ìŠ¤íŠ¸</h1>
            <span style="color:#27ae60; font-weight:bold; font-size:0.85rem;">â— hunterquest-fbdee ì„œë²„ ì—°ë™ë¨</span>
        </div>
        <button class="btn-reset" id="btn-reset-all">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>

    <div class="stats">
        <div class="stat-box">ì „ì²´: <span id="total-cnt">0</span></div>
        <div class="stat-box" style="color:#e67e22;">â³ ëŒ€ê¸°: <span id="waiting-cnt">0</span></div>
        <div class="stat-box" style="color:#2980b9;">ğŸ”¥ ì§„í–‰: <span id="active-cnt">0</span></div>
    </div>

    <section>
        <h2>ğŸ”¥ ì§„í–‰ ì¤‘ (3 Slots)</h2>
        <div class="slots-container" id="slots-container"></div>
    </section>

    <section>
        <h2>â³ ëŒ€ê¸° ëª…ë‹¨ (ì „ì²´ ë³´ê¸°)</h2>
        <div style="margin-bottom:15px; background:#e8f6f3; padding:10px; border-radius:4px; color:#16a085; font-size:0.9rem; line-height: 1.5;">
            <strong>ğŸš€ ë£° ì•ˆë‚´:</strong><br>
            <strong>ğŸ¯ ìˆœì„œ:</strong> 1.ì™„ë£Œ íšŸìˆ˜ ì ìŒ &gt; 2.ì‹ ì²­ ìˆœì„œ (ì„ ì°©ìˆœ)<br>
            1. í€˜ìŠ¤íŠ¸ ì¤‘ë³µ ì‹œ ì…ì¥ ë¶ˆê°€ (ê²¹ì¹˜ë©´ ìˆœë²ˆ ìœ ì§€)<br>
            2. <strong>[â–¼ ìˆœë²ˆë¯¸ë£¨ê¸°]</strong>: ê°™ì€ í€˜ìŠ¤íŠ¸ ëŒ€ê¸°ìê°€ ìˆìœ¼ë©´ êµì²´, ì—†ìœ¼ë©´ ë’·ì‚¬ëŒì—ê²Œ ì–‘ë³´<br>
        </div>
        <div class="queue-container">
            <div class="queue-list" id="queue-list"></div>
        </div>
    </section>

    <section>
        <h2>ğŸ‘¥ ì „ì²´ ì°¸ì—¬ì ê´€ë¦¬</h2>
        <div style="margin-bottom:10px; color:#d35400; font-size:0.9rem;">
            * ì™„ë£Œ íšŸìˆ˜ ìˆ«ìë¥¼ í´ë¦­í•˜ê³  ìˆ˜ì • í›„ <strong>ì—”í„°(Enter)</strong>ë¥¼ ëˆ„ë¥´ë©´ ì €ì¥ë©ë‹ˆë‹¤.
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="8%">ID</th>
                        <th width="25%">ì´ë¦„</th>
                        <th width="12%">ì™„ë£Œ</th>
                        <th width="25%">ìƒíƒœ / í€˜ìŠ¤íŠ¸</th>
                        <th width="20%">ì‹œì‘ ì‹œê°„</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="participant-table"></tbody>
            </table>
        </div>
    </section>

    <div class="control-panel" style="text-align: center;">
        <button class="btn-excel" onclick="window.openLogModal()" style="font-size: 1rem; padding: 15px 30px;">
            ğŸ“‹ ë³€ê²½ ë¡œê·¸ ë³´ê¸° (ê´€ë¦¬ì)
        </button>
    </div>

    <div class="control-panel">
        <div class="input-wrapper">
            <div class="input-group" style="flex: 2;">
                <strong>ğŸ‘¤ ê°œë³„:</strong>
                <input type="text" id="new-name" class="input-text" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" >
            </div>
            <button class="btn-add" id="btn-add-user" style="flex: 1;">ë“±ë¡</button>
        </div>
        <div style="margin-top: 10px;">
            <input type="file" id="excel-file" accept=".xlsx, .xls" style="display: none;" onchange="window.handleExcelUpload(event)">
            <button class="btn-excel" style="width:100%;" onclick="document.getElementById('excel-file').click()">
                ğŸ“‚ ì—‘ì…€ ì¼ê´„ ë“±ë¡
            </button>
        </div>
    </div>
</div>

<div id="roleModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0;">í€˜ìŠ¤íŠ¸ ì„ íƒ</h3>
        <p style="color:#666; font-size:0.9rem;">ì§„í–‰í•  í€˜ìŠ¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
        <div class="role-btn-group">
            <button class="btn-role role-tainer" onclick="confirmRole('í…Œì´ë„ˆ')">1. í…Œì´ë„ˆ</button>
            <button class="btn-role role-hide" onclick="confirmRole('í•˜ì´ë“œ')">2. í•˜ì´ë“œ</button>
            <button class="btn-role role-perfo" onclick="confirmRole('í¼í¬')">3. í¼í¬</button>
        </div>
        <button class="btn-cancel-modal" onclick="closeModal()">ì·¨ì†Œ</button>
    </div>
</div>

<div id="logModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 1200px; width: 90%; min-height: 500px; max-height: 85vh; overflow-y: auto; padding: 25px;">
        <h3 style="margin-top:0;">ğŸ“‹ ë³€ê²½ ë¡œê·¸ (ìµœê·¼ 100ê°œ)</h3>
        <button class="btn-excel" onclick="window.refreshLogsInModal()" style="margin-bottom: 15px; width: auto;">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
        <div class="table-wrapper" style="min-height: 300px;">
            <table>
                <thead>
                    <tr>
                        <th width="18%">ì‹œê°„</th>
                        <th width="12%">ì‚¬ìš©ì</th>
                        <th width="12%">ë³€ê²½ í•­ëª©</th>
                        <th width="15%">ì´ì „ ê°’</th>
                        <th width="15%">ìƒˆ ê°’</th>
                        <th width="15%">ë³€ê²½ì</th>
                    </tr>
                </thead>
                <tbody id="log-table-modal"></tbody>
            </table>
        </div>
        <button class="btn-cancel-modal" onclick="window.closeLogModal()" style="margin-top: 15px;">ë‹«ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // ========================================
    // ìƒìˆ˜ ì •ì˜ (Constants)
    // ========================================
    const CONSTANTS = {
        VERSION: "3.5.3-MIDNIGHT-FIX",
        MAX_ACTIVE_SLOTS: 3,
        MAX_ENABLED_BUTTONS: 4,
        LOG_DISPLAY_COUNT: 100,
        // âš ï¸ ë³´ì•ˆ ê²½ê³ : ë¹„ë°€ë²ˆí˜¸ê°€ í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œë¨
        // ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” Firebase Authentication ì‚¬ìš© ê¶Œì¥
        SITE_PASSWORD: "1234",
        RESET_PASSWORD: "0000",
        EDIT_PASSWORD: "9876"
    };

    const firebaseConfig = {
        apiKey: "AIzaSyBJ9CRer5FEjA1_yZ5g1jBypaX_3Cpqqyo",
        authDomain: "hunterquest-fbdee.firebaseapp.com",
        databaseURL: "https://hunterquest-fbdee-default-rtdb.firebaseio.com",
        projectId: "hunterquest-fbdee",
        storageBucket: "hunterquest-fbdee.firebasestorage.app",
        messagingSenderId: "999017602063",
        appId: "1:999017602063:web:711b798bb7405ddbfe577a",
        measurementId: "G-13WEG56NZR"
    };

    // ========================================
    // í—¬í¼ í•¨ìˆ˜ (Helper Functions)
    // ========================================
    
    /**
     * ìœ íš¨í•œ ì‚¬ìš©ìë§Œ í•„í„°ë§ (null, undefined ì œê±°)
     */
    const getValidUsers = (users) => {
        if (!users) return [];
        if (Array.isArray(users)) {
            return users.filter(u => u && u.id);
        }
        // ê°ì²´ë¡œ ë³€í™˜ëœ ê²½ìš° ë°°ì—´ë¡œ ë³€í™˜
        return Object.values(users).filter(u => u && u.id);
    };

    /**
     * ìˆœì°¨ì ì¸ ê³ ìœ  ID ìƒì„± (1, 2, 3...)
     * @param {Array} existingUsers - ê¸°ì¡´ ì‚¬ìš©ì ë°°ì—´
     * @returns {number} ê³ ìœ í•œ ID
     */
    const generateUniqueId = (existingUsers) => {
        if (existingUsers.length === 0) {
            return 1; // ì²« ë²ˆì§¸ ì‚¬ìš©ìëŠ” ID 1
        }
        
        // ê¸°ì¡´ ID ì¤‘ ìµœëŒ€ê°’ ì°¾ê¸°
        const maxId = Math.max(...existingUsers.map(u => u.id || 0));
        return maxId + 1;
    };

    /**
     * ëŒ€ê¸°ì—´ ì •ë ¬ ë¡œì§
     * 1ìˆœìœ„: postponedOrder (ë¯¸ë£¨ê¸° ìˆœì„œ)
     * 2ìˆœìœ„: completedCount (ì™„ë£Œ íšŸìˆ˜ ì ì€ ìˆœ - 0íšŒë¶€í„° ìš°ì„ )
     * 3ìˆœìœ„: waitingTime (ì‹ ì²­ ì‹œê°„ ë¹ ë¥¸ ìˆœ)
     */
    const sortWaitingUsers = (users) => {
        return users.sort((a, b) => {
            // 1. ì—­í• ë³„ ê·¸ë£¹í™” (í…Œì´ë„ˆ > í•˜ì´ë“œ > í¼í¬ ìˆœì„œ)
            // ì—­í•  ì—†ëŠ” ì‚¬ìš©ìëŠ” ë§¨ ë’¤ë¡œ
            const roleOrder = { 'í…Œì´ë„ˆ': 1, 'í•˜ì´ë“œ': 2, 'í¼í¬': 3 };
            const aRoleOrder = (a.role && roleOrder[a.role]) ? roleOrder[a.role] : 999;
            const bRoleOrder = (b.role && roleOrder[b.role]) ? roleOrder[b.role] : 999;
            
            if (aRoleOrder !== bRoleOrder) {
                return aRoleOrder - bRoleOrder;
            }
            
            // 2. ê°™ì€ ì—­í•  ë‚´ì—ì„œ ë¯¸ë£¨ê¸° ìˆœì„œ
            const aPostponed = a.postponedOrder ?? 0;
            const bPostponed = b.postponedOrder ?? 0;
            
            if (aPostponed !== bPostponed) {
                return aPostponed - bPostponed;
            }
            
            // 3. ì™„ë£Œ íšŸìˆ˜ ì ì€ ìˆœ (0íšŒë¶€í„° ìš°ì„ )
            if (a.completedCount !== b.completedCount) {
                return a.completedCount - b.completedCount;
            }
            
            // 4. ì‹ ì²­ ì‹œê°„ ë¹ ë¥¸ ìˆœ
            return (a.waitingTime || 0) - (b.waitingTime || 0);
        });
    };

    /**
     * ì—­í•  ë±ƒì§€ HTML ìƒì„±
     */
    const getRoleBadge = (role) => {
        if (!role) return '';
        let className = 'role-all';
        if (role === 'í…Œì´ë„ˆ') className = 'role-tainer';
        else if (role === 'í•˜ì´ë“œ') className = 'role-hide';
        else if (role === 'í¼í¬') className = 'role-perfo';
        return `<span class="role-badge ${className}">${role}</span>`;
    };

    /**
     * ê²½ê³¼ ì‹œê°„ ê³„ì‚° (ìì • ë„˜ê¹€ ì²˜ë¦¬ í¬í•¨)
     * @param {string} startTime - "HH:MM:SS" í˜•ì‹ì˜ ì‹œì‘ ì‹œê°„
     * @returns {string} "Në¶„ ê²½ê³¼" í˜•ì‹ì˜ ë¬¸ìì—´
     */
    const getElapsedTime = (startTime) => {
        if (!startTime) return '';
        
        try {
            const timePattern = /^(\d{1,2}):(\d{2}):(\d{2})$/;
            const match = startTime.match(timePattern);
            
            if (!match) return '';
            
            const now = new Date();
            // ì¼ë‹¨ 'ì˜¤ëŠ˜' ë‚ ì§œì— ì‹œì‘ ì‹œê°„ì„ ë¶™ì—¬ì„œ ì‹œê°„ ê°ì²´ ìƒì„±
            const today = now.getFullYear() + '-' + 
                          String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                          String(now.getDate()).padStart(2, '0');
            let startDateTime = new Date(`${today}T${startTime}`);
            
            if (isNaN(startDateTime.getTime())) return '';
            
            // ğŸš¨ í•µì‹¬ ìˆ˜ì •: ë§Œì•½ ì‹œì‘ ì‹œê°„ì´ í˜„ì¬ë³´ë‹¤ ë¯¸ë˜ë¼ë©´? (ì˜ˆ: ì§€ê¸ˆì€ 02ì‹œì¸ë° ì‹œì‘ì´ 22ì‹œ)
            // -> "ì•„, ì–´ì œ 22ì‹œì— ì‹œì‘í–ˆêµ¬ë‚˜"ë¼ê³  íŒë‹¨í•´ì„œ ë‚ ì§œë¥¼ í•˜ë£¨ ëºŒ
            if (startDateTime > now) {
                startDateTime.setDate(startDateTime.getDate() - 1);
            }
            
            const diffMs = now - startDateTime;
            const diffMinutes = Math.floor(diffMs / 60000);
            
            if (diffMinutes < 1) {
                return 'ë°©ê¸ˆ ì‹œì‘';
            } else if (diffMinutes < 60) {
                return `${diffMinutes}ë¶„ ê²½ê³¼`;
            } else {
                const hours = Math.floor(diffMinutes / 60);
                const mins = diffMinutes % 60;
                // 5~7ì‹œê°„ì´ë©´ ë¶„ ë‹¨ìœ„ê¹Œì§€ ë³´ì—¬ì£¼ëŠ” ê²Œ ì¢‹ì„ ê²ƒ ê°™ì•„ í˜•ì‹ì„ ì‚´ì§ ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤
                return `${hours}ì‹œê°„ ${mins}ë¶„ ê²½ê³¼`; 
            }
        } catch (error) {
            console.error('ê²½ê³¼ ì‹œê°„ ê³„ì‚° ì˜¤ë¥˜:', error);
            return '';
        }
    };

    // ========================================
    // Firebase ì´ˆê¸°í™” ë° ë°ì´í„° ê´€ë¦¬
    // ========================================
    
    window.checkPassword = () => {
        const input = document.getElementById('password-input').value;
        const errorMsg = document.getElementById('password-error');
        if (input === CONSTANTS.SITE_PASSWORD) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('loading-cover').style.display = 'flex';
            startFirebase(); 
        } else {
            errorMsg.style.display = 'block';
            document.getElementById('password-input').value = '';
            document.getElementById('password-input').focus();
        }
    };

    function startFirebase() {
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // ì‹¤ì œ DB ì‚¬ìš©
        const dbRef = ref(db, 'eka_quest_users');
        window.changeLogRef = ref(db, 'eka_change_logs');

        window.users = [];
        window.MAX_ACTIVE = CONSTANTS.MAX_ACTIVE_SLOTS;
        window.targetUserId = null;
        
        let isSaving = false;
        let logCounter = 0;
        
        /**
         * ë³€ê²½ ë¡œê·¸ ì €ì¥
         */
        window.logChange = (userId, userName, field, oldValue, newValue, changedBy = 'ì‹œìŠ¤í…œ') => {
            try {
                const timestamp = new Date().toLocaleString('ko-KR', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                });
                
                const logEntry = {
                    timestamp: timestamp, 
                    userId: userId, 
                    userName: userName,
                    field: field, 
                    oldValue: String(oldValue), 
                    newValue: String(newValue), 
                    changedBy: changedBy
                };
                
                const uniqueKey = Date.now() + '_' + (logCounter++);
                const newLogRef = ref(db, 'eka_change_logs/' + uniqueKey);
                
                set(newLogRef, logEntry).catch(error => {
                    console.error('ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', error);
                });
                
                console.log('[ë³€ê²½ ë¡œê·¸]', logEntry);
            } catch (error) {
                console.error('ë¡œê·¸ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
            }
        };

        /**
         * ë°ì´í„° ìˆ˜ì‹  (ì‹¤ì‹œê°„ ë™ê¸°í™”)
         */
        onValue(dbRef, (snapshot) => {
            try {
                const data = snapshot.val();
                if (data) {
                    window.users = getValidUsers(data);
                } else {
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                    window.users = [];
                }
                render();
                document.getElementById('loading-cover').style.display = 'none';
            } catch (error) {
                console.error('ë°ì´í„° ìˆ˜ì‹  ì˜¤ë¥˜:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                document.getElementById('loading-cover').style.display = 'none';
            }
        }, (error) => {
            console.error('Firebase ì—°ê²° ì˜¤ë¥˜:', error);
            alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + error.message);
            document.getElementById('loading-cover').style.display = 'none';
        });

        /**
         * ì•ˆì „í•œ ë°ì´í„° ì €ì¥ (Transaction ì‚¬ìš©)
         */
        window.saveData = (updateFunction) => {
            if (isSaving) {
                console.log('[ì €ì¥ ì¤‘... ëŒ€ê¸°]');
                return Promise.resolve();
            }

            isSaving = true;

            return runTransaction(dbRef, (currentData) => {
                try {
                    // null ì²´í¬ ë° ë°°ì—´ ë³€í™˜
                    if (currentData === null || currentData === undefined) {
                        currentData = [];
                    } else {
                        currentData = getValidUsers(currentData);
                    }
                    
                    // ì‚¬ìš©ì ì •ì˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì‹¤í–‰
                    if (updateFunction) {
                        const result = updateFunction(currentData);
                        // postponedOrderê°€ ì—†ëŠ” í•­ëª©ì— ëª…ì‹œì ìœ¼ë¡œ 0 í• ë‹¹
                        return result.map(user => ({
                            ...user,
                            postponedOrder: user.postponedOrder ?? 0
                        }));
                    } else {
                        return currentData.map(user => ({
                            ...user,
                            postponedOrder: user.postponedOrder ?? 0
                        }));
                    }
                } catch (error) {
                    console.error('Transaction ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì˜¤ë¥˜:', error);
                    return currentData;
                }
            }).then((result) => {
                isSaving = false;
                if (result.committed) {
                    console.log('[ì €ì¥ ì„±ê³µ - Transaction]');
                } else {
                    console.warn('[ì €ì¥ ì·¨ì†Œ - Transaction]');
                }
                return result;
            }).catch((error) => {
                isSaving = false;
                console.error('[ì €ì¥ ì‹¤íŒ¨]', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                throw error;
            });
        };
        
        /**
         * ê²½ê³¼ ì‹œê°„ ìë™ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
         */
        setInterval(() => {
            const activeUsers = window.users.filter(u => u && u.status === 'active');
            if (activeUsers.length > 0) {
                renderActiveSlots(activeUsers);
            }
        }, 60000); // 60ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
    }

    /**
     * ìˆœë²ˆ ë¯¸ë£¨ê¸° ë¡œì§ (ê°œì„  ë²„ì „)
     */
    function executePostponeLogic(targetUserId, currentData) {
        try {
            const validUsers = getValidUsers(currentData);
            const myUser = validUsers.find(u => u.id === targetUserId);
            
            if (!myUser || !myUser.role) {
                console.log('[ë¯¸ë£¨ê¸° ì‹¤íŒ¨] ì‚¬ìš©ì ì—†ìŒ ë˜ëŠ” ì—­í•  ì—†ìŒ');
                return currentData;
            }
            
            // ê°™ì€ ì—­í• ì˜ ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ìë“¤
            const waitingUsersWithRole = validUsers
                .filter(user => user.status === 'waiting' && user.role === myUser.role);
            
            // ì •ë ¬
            const sortedWaiting = sortWaitingUsers(waitingUsersWithRole);
            
            const currentIdx = sortedWaiting.findIndex(user => user.id === myUser.id);
            
            // ì²« ë²ˆì§¸ê°€ ì•„ë‹ˆê±°ë‚˜ ëŒ€ê¸°ìê°€ 1ëª… ì´í•˜ë©´ ë¯¸ë£¨ê¸° ë¶ˆê°€
            if (currentIdx !== 0 || sortedWaiting.length < 2) {
                console.log('[ë¯¸ë£¨ê¸° ë¶ˆê°€] ìˆœë²ˆì´ ì²« ë²ˆì§¸ê°€ ì•„ë‹ˆê±°ë‚˜ ëŒ€ê¸°ì ë¶€ì¡±');
                return currentData;
            }
            
            // í˜„ì¬ ë¯¸ë£¨ê¸° ìˆœì„œê°€ ìˆëŠ” ì‚¬ìš©ìë“¤ì˜ ìµœëŒ€ê°’ ì°¾ê¸°
            let maxPostponedOrder = 0;
            sortedWaiting.forEach(user => {
                const order = user.postponedOrder ?? 0;
                if (order > maxPostponedOrder) {
                    maxPostponedOrder = order;
                }
            });
            
            console.log('[ë¯¸ë£¨ê¸° ì‹¤í–‰] ì—­í• :', myUser.role, 'í˜„ì¬ max:', maxPostponedOrder);
            
            // ë¯¸ë£¨ê¸° ìˆœì„œ ì¦ê°€
            const oldOrder = myUser.postponedOrder ?? 0;
            myUser.postponedOrder = maxPostponedOrder + 1;
            
            window.logChange(
                myUser.id, 
                myUser.name, 
                "postponedOrder", 
                oldOrder, 
                maxPostponedOrder + 1, 
                "ìˆœë²ˆ ë¯¸ë£¨ê¸° ë²„íŠ¼"
            );
            
            return currentData;
        } catch (error) {
            console.error('[ë¯¸ë£¨ê¸° ë¡œì§ ì˜¤ë¥˜]', error);
            return currentData;
        }
    }

    // ========================================
    // UI ë Œë”ë§
    // ========================================
    
    function render() {
        try {
            const users = getValidUsers(window.users);
            
            // ëŒ€ê¸° ì¤‘ì¸ ì‚¬ìš©ì ì •ë ¬
            const waitingUsers = sortWaitingUsers(
                users.filter(u => u.status === 'waiting')
            );

            const activeUsers = users.filter(u => u.status === 'active');
            const currentRoles = activeUsers.map(u => u.role);

            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('total-cnt').innerText = users.length;
            document.getElementById('waiting-cnt').innerText = waitingUsers.length;
            document.getElementById('active-cnt').innerText = activeUsers.length;

            // í™œì„± ìŠ¬ë¡¯ ë Œë”ë§
            renderActiveSlots(activeUsers);
            
            // ëŒ€ê¸°ì—´ ë Œë”ë§
            renderQueueList(waitingUsers, currentRoles, activeUsers.length);
            
            // ì°¸ì—¬ì í…Œì´ë¸” ë Œë”ë§
            renderParticipantTable(users);
            
        } catch (error) {
            console.error('ë Œë”ë§ ì˜¤ë¥˜:', error);
        }
    }

    /**
     * í™œì„± ìŠ¬ë¡¯ ë Œë”ë§
     */
    function renderActiveSlots(activeUsers) {
        const slotsDiv = document.getElementById('slots-container');
        slotsDiv.innerHTML = '';
        
        for (let i = 0; i < CONSTANTS.MAX_ACTIVE_SLOTS; i++) {
            const user = activeUsers[i];
            const div = document.createElement('div');
            
            if (user) {
                const elapsedTime = getElapsedTime(user.startTime);
                const elapsedHTML = elapsedTime ? `<br><span style="color:#e67e22; font-weight:bold; font-size:0.9rem;">â±ï¸ ${elapsedTime}</span>` : '';
                
                div.className = 'slot active';
                div.innerHTML = `
                    <div>
                        <span class="info-badge bg-green">${user.completedCount}íšŒ ì™„ë£Œ</span>
                        <h3 style="margin:10px 0;">${getRoleBadge(user.role)} ${user.name}</h3>
                        <small style="color:#888">${user.startTime} ì‹œì‘${elapsedHTML}</small>
                    </div>
                    <button class="btn-action btn-end" onclick="finishWork(${user.id})">ì¢…ë£Œ (íšŸìˆ˜ +1)</button>
                `;
            } else {
                div.className = 'slot empty';
                div.innerHTML = `<h3>ë¹ˆ ìŠ¬ë¡¯ ${i + 1}</h3><div style="font-size:0.9rem;">ì…ì¥ ëŒ€ê¸° ì¤‘...</div>`;
            }
            slotsDiv.appendChild(div);
        }
    }

    /**
     * ëŒ€ê¸°ì—´ ë Œë”ë§
     */
    function renderQueueList(waitingUsers, currentRoles, activeCount) {
        const queueDiv = document.getElementById('queue-list');
        queueDiv.innerHTML = '';
        
        if (waitingUsers.length === 0) {
            queueDiv.innerHTML = '<div style="padding:15px; color:#999;">ëŒ€ê¸° ì¤‘ì¸ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        
        const hasEmptySlot = activeCount < CONSTANTS.MAX_ACTIVE_SLOTS;
        let enabledButtonCount = 0; 
        const queuedRoles = new Set(); 

        waitingUsers.forEach((u, idx) => {
            const card = document.createElement('div');
            card.className = 'queue-card';
            
            const isBlockedByActive = currentRoles.includes(u.role);
            const isBlockedByQueue = queuedRoles.has(u.role);
            queuedRoles.add(u.role);

            // ì…ì¥ ë²„íŠ¼ ìƒì„±
            let mainBtn = '';
            if (!hasEmptySlot) {
                mainBtn = `<button disabled class="btn-common-style btn-disabled-card">ìŠ¬ë¡¯ ê½‰ì°¸</button>`;
            } else if (isBlockedByActive) {
                mainBtn = `<button disabled class="btn-common-style btn-disabled-card" style="color:#e74c3c;">â›” ì§„í–‰ ì¤‘</button>`;
            } else if (isBlockedByQueue) {
                mainBtn = `<button disabled class="btn-common-style btn-blocked-queue">âœ‹ ëŒ€ê¸° ì¤‘</button>`;
            } else {
                if (enabledButtonCount < CONSTANTS.MAX_ENABLED_BUTTONS) {
                    mainBtn = `<button class="btn-common-style btn-enter" onclick="startWork(${u.id})">ì…ì¥ í•˜ê¸°</button>`;
                    enabledButtonCount++;
                } else {
                    mainBtn = `<div style="font-size:0.8rem; color:#aaa; font-weight:bold; padding:8px 0; width:100%;">ìˆœë²ˆ ${idx + 1}</div>`;
                }
            }

            // ìˆœë²ˆ ë¯¸ë£¨ê¸° ë²„íŠ¼
            let swapBtn = '';
            const sameRoleWaiting = waitingUsers.filter(user => user.role === u.role);
            if (sameRoleWaiting.length >= 2) {
                const roleIdx = sameRoleWaiting.findIndex(user => user.id === u.id);
                const isFirstInRole = roleIdx === 0;
                if (isFirstInRole) {
                    swapBtn = `<button class="btn-common-style btn-swap" onclick="window.postponeTurn(${u.id})">â–¼ ìˆœë²ˆë¯¸ë£¨ê¸°</button>`;
                } else {
                    swapBtn = `<button class="btn-common-style btn-swap" disabled style="opacity:0.5; cursor:not-allowed; background:#cbd5e0;">â–¼ ìˆœë²ˆë¯¸ë£¨ê¸°</button>`;
                }
            }

            // ë²„íŠ¼ ë°°ì¹˜
            let buttonHtml = '';
            if (mainBtn.includes('button')) { 
                buttonHtml = `<div class="btn-group">${mainBtn}${swapBtn}</div>`;
            } else { 
                buttonHtml = `${mainBtn}${swapBtn ? `<div class="btn-group">${swapBtn}</div>` : ''}`;
            }

            const cancelBtn = `<button class="btn-cancel-queue" onclick="window.cancelWaitingWithConfirm(${u.id})">ëŒ€ê¸° ì·¨ì†Œ</button>`;

            // ì—­í•  ì—†ëŠ” ê²½ìš° ê²½ê³  í‘œì‹œ
            const roleDisplay = u.role ? getRoleBadge(u.role) : '<span class="role-badge" style="background:#e74c3c;">âš ï¸ ì—­í• ì—†ìŒ</span>';
            const warningText = !u.role ? '<div style="color:#e74c3c; font-size:0.75rem; margin-top:5px;">â€» ëŒ€ê¸° ì·¨ì†Œ í›„ ì¬ì‹ ì²­ í•„ìš”</div>' : '';
            
            card.innerHTML = `
                <div class="queue-rank">${idx + 1}</div>
                <div style="margin-top:10px;">
                    ${roleDisplay}
                    <h4 style="margin:5px 0;">${u.name}</h4>
                    <small style="color:#888;">ì™„ë£Œ ${u.completedCount}íšŒ</small>
                    ${warningText}
                </div>
                ${buttonHtml}
                ${cancelBtn}
            `;
            queueDiv.appendChild(card);
        });
    }

    /**
     * ì°¸ì—¬ì í…Œì´ë¸” ë Œë”ë§
     */
    function renderParticipantTable(users) {
        const tbody = document.getElementById('participant-table');
        tbody.innerHTML = '';
        
        // ì •ë ¬: 1ìˆœìœ„ - ì™„ë£Œ íšŸìˆ˜ 1ì´ìƒ ìš°ì„ , 2ìˆœìœ„ - ID ìˆœ
        const allUsers = [...users].sort((a, b) => {
            const aHasCompleted = a.completedCount > 0 ? 0 : 1;
            const bHasCompleted = b.completedCount > 0 ? 0 : 1;
            
            // 1. í™œë™ ìœ ì €(0íšŒ ì´ìƒ) ìƒë‹¨, ë¯¸í™œë™(0íšŒ) í•˜ë‹¨ ì •ë ¬
            if (aHasCompleted !== bHasCompleted) {
                return aHasCompleted - bHasCompleted;
            }
            
            // 2. ê°™ì€ ê·¸ë£¹ ë‚´ì—ì„œëŠ” ID(ê°€ì…) ìˆœ
            return a.id - b.id;
        });

        allUsers.forEach(u => {
            const tr = document.createElement('tr');
            let statusHtml = '', actionBtn = '';

            if (u.status === 'idle') {
                statusHtml = '<span class="st-badge st-idle">ë¯¸ë“±ë¡</span>';
                actionBtn = `<button class="btn-apply" onclick="openRoleModal(${u.id})">ëŒ€ê¸° ì‹ ì²­</button>`;
            } else if (u.status === 'waiting') {
                statusHtml = `${getRoleBadge(u.role)} <span class="st-badge st-waiting">ëŒ€ê¸° ì¤‘</span>`;
                actionBtn = `<button class="btn-cancel" onclick="cancelWaiting(${u.id})">ì‹ ì²­ ì·¨ì†Œ</button>`;
            } else if (u.status === 'active') {
                statusHtml = `${getRoleBadge(u.role)} <span class="st-badge st-active">ì§„í–‰ ì¤‘</span>`;
                actionBtn = '-';
            }
            
            // 0íšŒ ì™„ë£Œì(ë¯¸í™œë™)ëŠ” ì‹œê°ì ìœ¼ë¡œ íë¦¬ê²Œ ì²˜ë¦¬
            const rowOpacity = (u.completedCount === 0) ? 'opacity: 0.6;' : '';

            tr.innerHTML = `
                <td style="${rowOpacity}">${u.id}</td>
                <td style="${rowOpacity}"><input type="text" class="edit-name" value="${u.name}" onchange="window.updateName(${u.id}, this.value)"></td>
                <td style="${rowOpacity}">
                    <input type="number" class="edit-count" value="${u.completedCount}" 
                           onchange="window.updateCompletedCount(${u.id}, this.value, this)">
                </td>
                <td style="${rowOpacity}">${statusHtml}</td>
                <td style="font-size:0.85rem; color:#666; ${rowOpacity}">${u.startTime || '-'}</td>
                <td>
                    ${actionBtn}
                    <button class="btn-delete" onclick="window.deleteUser(${u.id})">ì‚­ì œ</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ========================================
    // ì‚¬ìš©ì ì•¡ì…˜ í•¸ë“¤ëŸ¬
    // ========================================
    
    /**
     * ì™„ë£Œ íšŸìˆ˜ ìˆ˜ì •
     */
    window.updateCompletedCount = (id, newVal, inputEl) => {
        const validUsers = getValidUsers(window.users);
        const user = validUsers.find(u => u.id === id);
        if (!user) return;

        if (user.completedCount == newVal) return;

        const originalVal = user.completedCount;
        const parsedVal = parseInt(newVal);

        if (isNaN(parsedVal) || parsedVal < 0) {
            alert("ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            inputEl.value = originalVal;
            return;
        }

        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (íšŸìˆ˜ ìˆ˜ì •):");
        if (pw === CONSTANTS.EDIT_PASSWORD) {
            window.saveData((currentData) => {
                const validData = getValidUsers(currentData);
                const currentUser = validData.find(u => u.id === id);
                if (currentUser) {
                    window.logChange(id, user.name, 'completedCount', currentUser.completedCount, parsedVal, 'ê´€ë¦¬ì ì§ì ‘ ìˆ˜ì •');
                    currentUser.completedCount = parsedVal;
                }
                return validData;
            }).then(() => {
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            });
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            inputEl.value = originalVal;
        }
    };

    /**
     * ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ (ID ì¶©ëŒ ë°©ì§€ ê°œì„ )
     */
    window.handleExcelUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                if (jsonData.length === 0) {
                    alert("ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                window.saveData((currentData) => {
                    const validData = getValidUsers(currentData);
                    let addCount = 0;

                    jsonData.forEach((row) => {
                        if (row.length < 1) return; 
                        const name = String(row[0]).trim();
                        const exists = validData.some(u => u.name === name);
                        
                        if (!exists && name) {
                            const newId = generateUniqueId(validData);
                            validData.push({
                                id: newId,
                                name: name,
                                completedCount: 0,
                                role: '',
                                status: 'idle',
                                waitingTime: null,
                                startTime: null,
                                postponedOrder: 0
                            });
                            addCount++;
                        }
                    });
                    
                    alert(`${addCount}ëª…ì˜ ë°ì´í„°ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    return validData;
                });
                
                event.target.value = ''; 
            } catch (error) {
                console.error('ì—‘ì…€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };
        reader.onerror = () => {
            alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };
        reader.readAsArrayBuffer(file);
    };

    /**
     * ì—­í•  ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
     */
    window.openRoleModal = (id) => { 
        const validUsers = getValidUsers(window.users);
        const user = validUsers.find(u => u.id === id);
        if (user && user.status === 'waiting') {
            alert('ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤!\n\ní˜„ì¬ ëŒ€ê¸° ì—­í• : ' + user.role);
            return;
        }
        window.targetUserId = id; 
        document.getElementById('roleModal').style.display = 'flex'; 
    };
    
    /**
     * ì—­í•  í™•ì •
     */
    window.confirmRole = (role) => {
        // ì—­í• ì´ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ì²´í¬
        if (!role || role === '') {
            alert('í€˜ìŠ¤íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
            return;
        }
        
        if (window.targetUserId) {
            window.saveData((currentData) => {
                const validData = getValidUsers(currentData);
                const user = validData.find(u => u.id === window.targetUserId);
                if (user) {
                    if (user.status === 'waiting') {
                        alert('ì´ë¯¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤!\n\ní˜„ì¬ ëŒ€ê¸° ì—­í• : ' + user.role);
                        return validData;
                    }
                    
                    const oldRole = user.role || 'ì—†ìŒ';
                    const oldStatus = user.status;
                    window.logChange(user.id, user.name, 'role', oldRole, role, 'ëŒ€ê¸° ë“±ë¡ ëª¨ë‹¬');
                    window.logChange(user.id, user.name, 'status', oldStatus, 'waiting', 'ëŒ€ê¸° ë“±ë¡ ëª¨ë‹¬');
                    
                    user.status = 'waiting';
                    user.role = role;
                    user.waitingTime = Date.now();
                    user.postponedOrder = 0;
                }
                return validData;
            });
        }
        window.closeModal();
    };
    
    /**
     * ëª¨ë‹¬ ë‹«ê¸°
     */
    window.closeModal = () => { 
        window.targetUserId = null; 
        document.getElementById('roleModal').style.display = 'none'; 
    };
    
    /**
     * ëŒ€ê¸° ì·¨ì†Œ
     */
    window.cancelWaiting = (id) => {
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const user = validData.find(u => u.id === id);
            if (user) {
                window.logChange(user.id, user.name, 'status', 'waiting', 'idle', 'ëŒ€ê¸° ì·¨ì†Œ ë²„íŠ¼');
                if (user.role) {
                    window.logChange(user.id, user.name, 'role', user.role, '', 'ëŒ€ê¸° ì·¨ì†Œ ë²„íŠ¼ (ì—­í•  ì´ˆê¸°í™”)');
                }
                
                user.status = 'idle';
                user.waitingTime = null;
                user.role = '';
                user.postponedOrder = 0;
            }
            return validData;
        });
    };
    
    /**
     * ëŒ€ê¸° ì·¨ì†Œ (í™•ì¸ í¬í•¨)
     */
    window.cancelWaitingWithConfirm = (id) => {
        if (confirm('ëŒ€ê¸°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.cancelWaiting(id);
        }
    };
    
    /**
     * ì…ì¥ í•˜ê¸°
     */
    window.startWork = (id) => {
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const activeUsers = validData.filter(u => u.status === 'active');
            
            if (activeUsers.length >= CONSTANTS.MAX_ACTIVE_SLOTS) { 
                alert('ìŠ¬ë¡¯ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤.'); 
                return validData; 
            }
            
            const user = validData.find(u => u.id === id);
            if (!user) return validData;
            
            // ì—­í• ì´ ì—†ëŠ” ê²½ìš° ì²´í¬
            if (!user.role || user.role === '') {
                alert('âš ï¸ í€˜ìŠ¤íŠ¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!\nëŒ€ê¸°ë¥¼ ì·¨ì†Œí•˜ê³  ë‹¤ì‹œ ì‹ ì²­í•´ì£¼ì„¸ìš”.');
                return validData;
            }
            
            const isRoleTaken = activeUsers.some(activeUser => activeUser.role === user.role);
            if (isRoleTaken) { 
                alert(`ğŸš« ì…ì¥ ë¶ˆê°€: í˜„ì¬ [${user.role}] í€˜ìŠ¤íŠ¸ëŠ” ì´ë¯¸ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.`); 
                return validData; 
            }
            
            window.logChange(user.id, user.name, 'status', user.status, 'active', 'ì…ì¥ í•˜ê¸° ë²„íŠ¼');
            
            user.status = 'active';
            // 24ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ëª…í™•íˆ ì €ì¥ (HH:MM:SS)
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            user.startTime = `${hours}:${minutes}:${seconds}`;
            user.postponedOrder = 0;
            
            return validData;
        });
    };
    
    /**
     * í€˜ìŠ¤íŠ¸ ì™„ë£Œ
     */
    window.finishWork = (id) => {
        if (!confirm("í€˜ìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆë‚˜ìš”?\n(í™•ì¸ì„ ëˆ„ë¥´ë©´ ì™„ë£Œ íšŸìˆ˜ê°€ +1 ì¦ê°€í•©ë‹ˆë‹¤)")) {
            return;
        }
        
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const user = validData.find(u => u.id === id);
            if (user) {
                window.logChange(user.id, user.name, 'status', 'active', 'idle', 'ì™„ë£Œ ë²„íŠ¼');
                window.logChange(user.id, user.name, 'completedCount', user.completedCount, user.completedCount + 1, 'ì™„ë£Œ ë²„íŠ¼');
                if (user.role) {
                    window.logChange(user.id, user.name, 'role', user.role, '', 'ì™„ë£Œ ë²„íŠ¼ (ì—­í•  ì´ˆê¸°í™”)');
                }
                
                user.status = 'idle';
                user.completedCount += 1;
                user.startTime = null;
                user.role = ''; 
                user.postponedOrder = 0;
            }
            return validData;
        });
    };
    
    /**
     * ìˆœë²ˆ ë¯¸ë£¨ê¸° (ê°œì„  ë²„ì „ - ì „ì—­ ë³€ìˆ˜ ìˆ˜ì • ì œê±°)
     */
    window.postponeTurn = (currentId) => {
        window.saveData((currentData) => {
            return executePostponeLogic(currentId, currentData);
        });
    };

    /**
     * ìƒˆ ì‚¬ìš©ì ì¶”ê°€
     */
    window.addNewUser = () => {
        const nameInput = document.getElementById('new-name');
        const name = nameInput.value.trim();
        if (!name) {
            alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ì¤‘ë³µ ì²´í¬
        const validUsers = getValidUsers(window.users);
        const isDuplicate = validUsers.some(u => u.name === name);
        if (isDuplicate) {
            alert(`"${name}"ì€(ëŠ”) ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.`);
            nameInput.focus();
            return;
        }
        
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            
            // Transaction ë‚´ë¶€ì—ì„œë„ í•œ ë²ˆ ë” ì¤‘ë³µ ì²´í¬ (ë™ì‹œì„± ëŒ€ë¹„)
            const stillDuplicate = validData.some(u => u.name === name);
            if (stillDuplicate) {
                alert(`"${name}"ì€(ëŠ”) ì´ë¯¸ ë“±ë¡ëœ ì´ë¦„ì…ë‹ˆë‹¤.`);
                return validData;
            }
            
            const newId = generateUniqueId(validData);
            
            validData.push({ 
                id: newId, 
                name: name, 
                completedCount: 0, 
                role: '', 
                status: 'idle', 
                waitingTime: null, 
                startTime: null,
                postponedOrder: 0
            });
            
            return validData;
        }).then(() => {
            nameInput.value = '';
        });
    };
    
    /**
     * ì‚¬ìš©ì ì‚­ì œ
     */
    window.deleteUser = (id) => {
        if (confirm('ì •ë§ ì´ ì°¸ì—¬ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            window.saveData((currentData) => {
                const validData = getValidUsers(currentData);
                return validData.filter(u => u.id !== id);
            });
        }
    };
    
    /**
     * ì´ë¦„ ìˆ˜ì •
     */
    window.updateName = (id, val) => { 
        window.saveData((currentData) => {
            const validData = getValidUsers(currentData);
            const u = validData.find(u => u.id === id);
            if (u) { 
                u.name = val; 
            }
            return validData;
        });
    };
    
    /**
     * ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”
     */
    window.clearAllData = () => { 
        if (confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')) { 
            const input = prompt("ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (input === CONSTANTS.RESET_PASSWORD) {
                window.saveData(() => {
                    return [];
                }).then(() => {
                    alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                });
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            }
        } 
    };

    /**
     * ë¡œê·¸ ëª¨ë‹¬ ì—´ê¸°
     */
    window.openLogModal = () => {
        const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (password === CONSTANTS.EDIT_PASSWORD) {
            document.getElementById('logModal').style.display = 'flex';
            window.refreshLogsInModal();
        } else if (password !== null) {
            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
    };
    
    /**
     * ë¡œê·¸ ëª¨ë‹¬ ë‹«ê¸°
     */
    window.closeLogModal = () => {
        document.getElementById('logModal').style.display = 'none';
    };
    
    /**
     * ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
     */
    window.refreshLogsInModal = () => {
        onValue(window.changeLogRef, (snapshot) => {
            try {
                const logs = snapshot.val();
                const logTable = document.getElementById('log-table-modal');
                logTable.innerHTML = '';
                
                if (!logs) {
                    logTable.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999; padding: 50px; font-size: 1.1rem;">ğŸ“‹ ë³€ê²½ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br><br><span style="font-size:0.9rem; color:#bbb;">ì‚¬ìš©ìê°€ ì—­í•  ë³€ê²½, ì…ì¥, ì™„ë£Œ ë“±ì˜ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©´<br>ì—¬ê¸°ì— ë¡œê·¸ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</span></td></tr>';
                    return;
                }
                
                const logArray = Object.entries(logs)
                    .map(([key, value]) => ({
                        key: key,
                        ...value
                    }))
                    .sort((a, b) => parseInt(b.key) - parseInt(a.key))
                    .slice(0, CONSTANTS.LOG_DISPLAY_COUNT);
                
                logArray.forEach(log => {
                    const tr = document.createElement('tr');
                    
                    const fieldNames = {
                        'status': 'ìƒíƒœ',
                        'role': 'ì—­í• ',
                        'completedCount': 'ì™„ë£Œ íšŸìˆ˜',
                        'postponedOrder': 'ë¯¸ë£¨ê¸° ìˆœì„œ'
                    };
                    
                    const statusNames = {
                        'idle': 'ëŒ€ê¸°',
                        'waiting': 'ëŒ€ê¸°ì—´',
                        'active': 'ì§„í–‰ ì¤‘'
                    };
                    
                    const fieldName = fieldNames[log.field] || log.field;
                    let oldValue = statusNames[log.oldValue] || log.oldValue || '-';
                    let newValue = statusNames[log.newValue] || log.newValue || '-';
                    
                    tr.innerHTML = `
                        <td style="font-size:0.85rem;">${log.timestamp}</td>
                        <td><strong>${log.userName}</strong></td>
                        <td><span style="background:#3498db; color:white; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${fieldName}</span></td>
                        <td style="color:#e74c3c;">${oldValue}</td>
                        <td style="color:#27ae60;"><strong>${newValue}</strong></td>
                        <td style="font-size:0.85rem; color:#666;">${log.changedBy}</td>
                    `;
                    logTable.appendChild(tr);
                });
            } catch (error) {
                console.error('ë¡œê·¸ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
            }
        }, { onlyOnce: true });
    };
    
    /**
     * Enter í‚¤ í•¸ë“¤ëŸ¬
     */
    window.handleEnter = (e) => { 
        if (e.key === 'Enter') window.addNewUser(); 
    };

    // ========================================
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    // ========================================
    
    document.getElementById('btn-add-user').onclick = window.addNewUser;
    document.getElementById('btn-reset-all').onclick = window.clearAllData;
    document.getElementById('new-name').addEventListener('keypress', window.handleEnter);
    
    console.log('âœ¨ ì—ì¹´ í€˜ìŠ¤íŠ¸ ì‹œìŠ¤í…œ v' + CONSTANTS.VERSION + ' ë¡œë“œ ì™„ë£Œ');
</script>
</body>
</html>

}
